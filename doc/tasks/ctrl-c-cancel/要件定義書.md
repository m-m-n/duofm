# 要件定義書: Ctrl+Cによるキャンセル操作の追加

## 1. 概要

現在Escキーで実装されているキャンセル操作を、Ctrl+Cでも実行できるようにする。
また、通常画面でCtrl+Cを押した場合は、2秒以内に再度押すとプログラムを終了する機能を追加する。

## 2. ビジネス要件

### 2.1 背景
- 多くのCLI/TUIアプリケーションではCtrl+Cがキャンセル/中断の標準的なキーバインドとして認識されている
- ユーザーの操作習慣に合わせ、EscとCtrl+Cの両方でキャンセルできるようにすることで、直感的な操作を実現する

### 2.2 目的
- ユーザーの操作性向上
- 標準的なキーバインドへの対応
- 誤操作によるプログラム終了の防止（2回押し確認）

## 3. ユースケース

### UC-1: モーダル状態でのキャンセル
**アクター:** ユーザー
**前提条件:** ミニバッファ、ダイアログ、メニューのいずれかが表示されている
**基本フロー:**
1. ユーザーがCtrl+Cを押す
2. 現在のモーダル状態がキャンセルされる
3. 前の状態に戻る

**期待結果:** Escキーと同じ動作をする

### UC-2: 通常画面でのプログラム終了
**アクター:** ユーザー
**前提条件:** 通常のファイル一覧表示状態（モーダルなし）
**基本フロー:**
1. ユーザーがCtrl+Cを押す
2. ステータスバーに「Press Ctrl+C again to quit」と表示される
3. 2秒以内にユーザーが再度Ctrl+Cを押す
4. プログラムが終了する

**代替フロー:**
- 3a. 2秒以内に他のキーを押す → メッセージがクリアされ、通常操作に戻る
- 3b. 2秒経過 → メッセージが自動的にクリアされ、通常状態に戻る

## 4. 機能要件

### FR-1: Ctrl+Cによるキャンセル操作

| ID | 要件 | 優先度 |
|----|------|--------|
| FR-1.1 | 検索/ミニバッファ表示中にCtrl+Cで検索をキャンセルできる | 必須 |
| FR-1.2 | 確認ダイアログ表示中にCtrl+Cでダイアログをキャンセルできる | 必須 |
| FR-1.3 | エラーダイアログ表示中にCtrl+Cでダイアログを閉じられる | 必須 |
| FR-1.4 | ヘルプダイアログ表示中にCtrl+Cでダイアログを閉じられる | 必須 |
| FR-1.5 | コンテキストメニュー表示中にCtrl+Cでメニューを閉じられる | 必須 |

### FR-2: 通常画面でのCtrl+C動作

| ID | 要件 | 優先度 |
|----|------|--------|
| FR-2.1 | 通常画面で1回目のCtrl+Cを押すとステータスバーにメッセージを表示する | 必須 |
| FR-2.2 | メッセージは「Press Ctrl+C again to quit」とする | 必須 |
| FR-2.3 | 2秒以内に再度Ctrl+Cを押すとプログラムが終了する | 必須 |
| FR-2.4 | 2秒経過後はメッセージが自動的にクリアされる | 必須 |
| FR-2.5 | 他のキー入力があった場合もメッセージがクリアされる | 必須 |

## 5. 非機能要件

### NFR-1: パフォーマンス
- キー入力からの応答は即座（体感0ms）であること

### NFR-2: 一貫性
- EscキーとCtrl+Cの動作は完全に同一であること（キャンセル文脈において）

### NFR-3: 可読性
- ステータスバーのメッセージは明確で理解しやすいこと

## 6. UI/UX要件

### 6.1 ステータスバー表示

**1回目のCtrl+C押下時:**
```
Press Ctrl+C again to quit
```

- 背景色: 通常のステータスメッセージと同じ（グレー、color 240）
- 前景色: 白（color 15）
- エラー表示ではない（`isStatusError = false`）

### 6.2 タイミング
- メッセージ表示から2秒以内に再度Ctrl+Cで終了
- 2秒経過でメッセージ自動クリア

## 7. データ要件

### 7.1 状態管理
新たに以下の状態を管理する必要がある：

```go
// Ctrl+C終了確認の状態
ctrlCPending bool      // Ctrl+Cが1回押された状態かどうか
```

または、既存の`statusMessage`の内容で判断する方法も可能。

## 8. 制約条件

### 8.1 技術的制約
- Bubble Teaフレームワークの`tea.KeyCtrlC`を使用する
- 既存のEscキー処理と同じコードパスを通るようにする

### 8.2 互換性
- 既存のEscキーによるキャンセル動作に影響を与えない
- 既存の`q`キーによる終了動作は維持する

## 9. 成功基準

1. すべてのモーダル状態（ミニバッファ、各種ダイアログ、コンテキストメニュー）でCtrl+Cがキャンセルとして機能する
2. 通常画面でCtrl+Cを2回押すとプログラムが終了する
3. 1回目のCtrl+C後、2秒以内に操作しなければ通常状態に戻る
4. 既存のEscキー動作が変わらない
5. 既存のテストがすべてパスする

## 10. テストシナリオ

### TS-1: ミニバッファでのCtrl+Cキャンセル
1. `/`キーで検索を開始
2. 「test」と入力
3. Ctrl+Cを押す
4. **期待結果:** 検索がキャンセルされ、ミニバッファが閉じる

### TS-2: 確認ダイアログでのCtrl+Cキャンセル
1. ファイルを選択して`d`キーで削除確認ダイアログを表示
2. Ctrl+Cを押す
3. **期待結果:** ダイアログが閉じ、削除はキャンセルされる

### TS-3: コンテキストメニューでのCtrl+Cキャンセル
1. `@`キーでコンテキストメニューを表示
2. Ctrl+Cを押す
3. **期待結果:** メニューが閉じる

### TS-4: 通常画面での2回Ctrl+Cによる終了
1. 通常のファイル一覧表示状態
2. Ctrl+Cを押す
3. **期待結果:** ステータスバーに「Press Ctrl+C again to quit」と表示
4. 2秒以内に再度Ctrl+Cを押す
5. **期待結果:** プログラムが終了する

### TS-5: 通常画面でのCtrl+Cタイムアウト
1. 通常のファイル一覧表示状態
2. Ctrl+Cを押す
3. **期待結果:** ステータスバーにメッセージ表示
4. 2秒以上待機
5. **期待結果:** メッセージがクリアされ、通常状態に戻る

### TS-6: Ctrl+C後の他キー入力
1. 通常のファイル一覧表示状態
2. Ctrl+Cを押す
3. **期待結果:** ステータスバーにメッセージ表示
4. `j`キーなど他のキーを押す
5. **期待結果:** メッセージがクリアされ、通常の操作が行われる

## 11. 確認済み事項

| 項目 | 確認内容 |
|------|----------|
| 対象範囲 | Escでキャンセルできるすべてのモーダル状態 |
| 終了確認 | 通常画面で2回Ctrl+Cを押すと終了 |
| タイムアウト | 2秒 |
| メッセージ表示 | ステータスバーに表示 |
| メッセージクリア | 2秒経過または他キー入力でクリア |

## 12. 影響範囲

### 12.1 変更が必要なファイル
- `internal/ui/model.go` - キーハンドリングとCtrl+C状態管理
- `internal/ui/confirm_dialog.go` - Ctrl+C対応追加
- `internal/ui/error_dialog.go` - Ctrl+C対応追加
- `internal/ui/help_dialog.go` - Ctrl+C対応追加
- `internal/ui/context_menu_dialog.go` - Ctrl+C対応追加

### 12.2 影響を受けるテスト
- `internal/ui/model_test.go` - 新規テストケース追加
