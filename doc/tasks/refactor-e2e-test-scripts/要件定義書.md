# E2Eテストスクリプトのリファクタリング - 要件定義書

## 1. 概要

### 1.1 背景

現在、duofmのE2Eテストは `test/e2e/scripts/run_tests.sh` という単一のファイルに全て集約されています。このファイルは以下の問題を抱えています：

- **ファイルサイズ**: 2,867行、83KB、27,170トークン
- **テスト関数数**: 78個
- **問題点**: Claudeが一度に読み込めるトークン制限（25,000トークン）を超えており、AI支援による開発・保守が困難

### 1.2 目的

**主目的**: Claudeが一度に読み込んで正しく判断できるよう、ファイルサイズを削減する

**副次的な目的**:
- テストの論理的なまとまりを明確化し、保守性を向上させる
- 個別のテストカテゴリを選択的に実行できるようにする
- 新しいテストの追加を容易にする

### 1.3 スコープ

**対象ファイル**:
- `test/e2e/scripts/run_tests.sh` (2,867行) - リファクタリング対象

**対象外**:
- `test/e2e/scripts/helpers.sh` - 変更不要（そのまま利用）
- `test/e2e/scripts/test_open_file.sh` - 既存の個別テストファイル（参考として維持）
- `test/e2e/scripts/interactive.sh` - 変更不要

## 2. ドメインルール

### 2.1 テストの独立性

- 各テスト関数は独立して実行可能でなければならない
- テスト間に実行順序の依存関係があってはならない
- 各テストは独自のtmuxセッションで実行される

### 2.2 テストの完全性

- 既存の78個のテスト関数は全て維持する
- テストの動作や検証内容は変更しない
- テストの削除や統合は行わない

### 2.3 後方互換性

- CI/CDでの使用実績がないため、後方互換性の維持は不要
- 既存の `run_tests.sh` は削除または置き換え可能

## 3. 機能要件

### FR1: テストファイルの分割

**FR1.1**: 機能カテゴリに基づいてテストファイルを分割する

以下のカテゴリでテストファイルを作成する：

| ファイル名 | 説明 | 含まれるテスト例 | 想定テスト数 |
|-----------|------|------------------|--------------|
| `basic_tests.sh` | 基本機能 | 起動、終了、基本ナビゲーション | 8-10 |
| `directory_tests.sh` | ディレクトリ操作 | ディレクトリ移動、ペイン同期 | 8-12 |
| `file_operation_tests.sh` | ファイル基本操作 | 作成、削除、リネーム | 10-15 |
| `copy_move_tests.sh` | コピー・移動操作 | コピー、移動、上書き処理 | 8-12 |
| `ui_tests.sh` | UI・ダイアログ | ヘルプ、検索、確認ダイアログ | 6-10 |
| `cursor_tests.sh` | カーソル位置記憶 | ナビゲーション後のカーソル保持 | 4-6 |
| `sort_tests.sh` | ソート機能 | ソートダイアログ、ソート動作 | 8-10 |
| `shell_tests.sh` | シェルコマンド | シェルコマンドモード | 5-8 |
| `config_tests.sh` | 設定管理 | 設定ファイル、キーバインディング | 4-6 |
| `bookmark_tests.sh` | ブックマーク | ブックマーク追加・表示 | 3-5 |
| `mark_tests.sh` | マーク機能 | ファイルマーク、バッチ操作 | 6-8 |

**FR1.2**: 各分割ファイルは独立して実行可能である

- 各ファイルは `helpers.sh` をsourceする
- 各ファイルは単独で実行した場合、自身のテストのみを実行する
- 各ファイルは他のテストファイルに依存しない

**FR1.3**: 各分割ファイルのサイズは論理的なまとまりを優先する

- 厳密な行数制限は設けない
- 関連するテストは同じファイルに配置する
- 目安として200-500行程度を想定（Claudeが余裕で読める範囲）

### FR2: メインテストランナーの作成

**FR2.1**: 全テストを実行するメインランナー `run_all_tests.sh` を作成する

- 全てのテストファイルをsourceして実行
- テスト結果のサマリーを表示
- 失敗したテストがある場合は非ゼロの終了コードを返す

**FR2.2**: 個別カテゴリのテストを実行できる

メインランナーは引数により実行対象を制御できる：

```bash
./run_all_tests.sh              # 全テスト実行
./run_all_tests.sh basic        # basic_tests.shのみ実行
./run_all_tests.sh file-ops     # file_operation_tests.shのみ実行
./run_all_tests.sh copy-move    # copy_move_tests.shのみ実行
```

### FR3: ディレクトリ構造

**FR3.1**: 以下のディレクトリ構造を採用する

```
test/e2e/scripts/
├── helpers.sh                    # 既存の補助関数（変更なし）
├── run_all_tests.sh             # メインテストランナー（新規作成）
├── tests/                       # テストファイル格納ディレクトリ（新規）
│   ├── basic_tests.sh
│   ├── directory_tests.sh
│   ├── file_operation_tests.sh
│   ├── copy_move_tests.sh
│   ├── ui_tests.sh
│   ├── cursor_tests.sh
│   ├── sort_tests.sh
│   ├── shell_tests.sh
│   ├── config_tests.sh
│   ├── bookmark_tests.sh
│   └── mark_tests.sh
├── test_open_file.sh            # 既存ファイル（変更なし）
└── interactive.sh               # 既存ファイル（変更なし）
```

### FR4: テストファイルの構造

**FR4.1**: 各テストファイルは以下の構造を持つ

```bash
#!/bin/bash
# [Category] Tests for duofm
#
# Description: [このファイルに含まれるテストの概要]
# Tests: [テスト数]

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/../helpers.sh"

# ===========================================
# Test: [テスト名]
# ===========================================
test_name() {
    # テスト実装
}

# 他のテスト関数...

# このファイルが直接実行された場合
if [ "${BASH_SOURCE[0]}" = "${0}" ]; then
    run_test test_name
    # 他のテスト実行...
    print_summary
    exit $?
fi
```

**FR4.2**: テスト関数は既存のものをそのまま移行する

- テスト関数のコードは変更しない
- テスト関数名は変更しない
- テストの動作は維持する

## 4. 非機能要件

### NFR1: パフォーマンス

**NFR1.1**: 全テストの実行時間は現状と同等またはそれ以下である

- ファイル分割によるオーバーヘッドは最小限に抑える
- 個別実行により部分的なテスト実行が可能になり、開発時の待ち時間が削減される

### NFR2: 保守性

**NFR2.1**: 各テストファイルはClaudeのトークン制限（25,000トークン）内に収まる

- 目標: 各ファイルを5,000-10,000トークン以下に抑える
- 最大でも20,000トークン以下とする

**NFR2.2**: テストの追加・修正が容易である

- 新しいテストは適切なカテゴリファイルに追加するだけでよい
- 関連するテストが同じファイルにまとまっており、理解しやすい

### NFR3: 互換性

**NFR3.1**: `helpers.sh` の変更は不要

- 既存のhelper関数は全て利用可能
- 新しいhelper関数の追加は必要に応じて行う

**NFR3.2**: tmuxベースのテスト実行方式は維持する

- 既存のテスト方法論は変更しない
- `start_duofm`, `send_keys`, `assert_contains` などの関数は引き続き使用

## 5. 制約条件

### 5.1 技術的制約

- Bashスクリプトで実装する
- tmuxを使用したE2Eテスト方式を維持する
- 既存のhelpers.shに依存する

### 5.2 リソース制約

- 既存のテストデータ（/testdata）をそのまま使用する
- 新しい依存関係（外部ツール）の追加は避ける

### 5.3 運用制約

- CI/CDでの後方互換性は不要（現在使用していない）
- 開発環境での動作確認が可能であればよい

## 6. テスト移行マッピング

以下は既存のテストを新しいファイルに割り当てるマッピングです：

### basic_tests.sh (8テスト)
- test_basic_startup
- test_jk_navigation
- test_enter_directory
- test_parent_directory
- test_pane_switching
- test_help_dialog
- test_search_filter
- test_quit
- test_ctrlc_quit

### directory_tests.sh (10テスト)
- test_symlink_display
- test_permission_denied_directory
- test_f5_refresh
- test_ctrlr_refresh
- test_refresh_cursor_preservation
- test_sync_pane
- test_sync_preserves_settings
- test_sync_right_to_left
- test_right_pane_same_path_navigation
- test_right_pane_home_navigation

### file_operation_tests.sh (13テスト)
- test_cannot_delete_root_file
- test_can_delete_user_file
- test_create_new_file
- test_create_new_directory
- test_rename_file
- test_cancel_file_creation
- test_empty_filename_error
- test_rename_parent_dir_ignored
- test_navigation_after_file_creation
- test_navigation_after_dir_creation
- test_navigation_after_rename
- test_rename_dialog_validation
- test_create_file_in_empty_dir

### copy_move_tests.sh (10テスト)
- test_copy_overwrite_cancel
- test_copy_overwrite_confirm
- test_copy_overwrite_rename
- test_move_overwrite
- test_directory_conflict_error
- test_overwrite_dialog_navigation
- test_copy_no_conflict
- test_move_no_conflict
- test_copy_to_opposite_pane
- test_move_to_opposite_pane

### ui_tests.sh (8テスト)
- test_help_dialog（重複チェック - basic_testsと調整）
- test_search_filter（重複チェック - basic_testsと調整）
- test_dialog_escape_key
- test_context_menu_navigation
- test_overwrite_dialog_navigation（重複チェック - copy_move_testsと調整）
- test_rename_dialog_validation（重複チェック - file_operation_testsと調整）
- test_context_menu_mark_count

### cursor_tests.sh (4テスト)
- test_cursor_preserved_after_view
- test_cursor_preserved_after_enter_view
- test_cursor_reset_when_file_deleted
- test_both_panes_preserve_cursor
- test_parent_nav_cursor_on_subdir_h_key
- test_parent_nav_cursor_on_subdir_dotdot
- test_parent_nav_cursor_on_subdir_l_key
- test_parent_nav_independent_pane_memory

### sort_tests.sh (10テスト)
- test_sort_dialog_opens
- test_sort_dialog_hl_navigation
- test_sort_dialog_jk_navigation
- test_sort_dialog_confirm
- test_sort_dialog_cancel
- test_sort_dialog_q_cancel
- test_sort_by_size_desc
- test_sort_persists_after_navigation
- test_sort_independent_panes
- test_sort_dialog_arrow_keys

### shell_tests.sh (6テスト)
- test_shell_command_mode_enter
- test_shell_command_input
- test_shell_command_empty_enter
- test_shell_command_ignored_with_dialog
- test_shell_command_ignored_during_search
- test_help_shows_shell_command

### config_tests.sh (5テスト)
- test_config_auto_generated
- test_config_has_keybindings
- test_config_has_comments
- test_default_keybindings_without_config
- test_help_shows_pascalcase

### bookmark_tests.sh (3テスト)
- test_bookmark_dialog_opens
- test_add_bookmark_dialog
- test_bookmark_empty_state

### mark_tests.sh (7テスト)
- test_mark_file
- test_mark_cursor_movement
- test_unmark_file
- test_mark_parent_dir_ignored
- test_mark_multiple_files
- test_marks_cleared_on_directory_change
- test_batch_delete_marked_files
- test_context_menu_mark_count（重複チェック - ui_testsと調整）

## 7. 成功基準

### 7.1 ファイルサイズ

- [ ] 全ての分割ファイルがClaudeのトークン制限（25,000トークン）内に収まる
- [ ] 最大のファイルでも20,000トークン以下である

### 7.2 テスト完全性

- [ ] 既存の78個のテスト関数が全て新しい構造に移行されている
- [ ] 全テストが実行され、パスする
- [ ] テストの動作が変更されていない（検証内容が同じ）

### 7.3 実行可能性

- [ ] `./run_all_tests.sh` で全テストが実行できる
- [ ] `./run_all_tests.sh basic` のように個別カテゴリのテストが実行できる
- [ ] `./tests/basic_tests.sh` のように各テストファイルを直接実行できる
- [ ] テスト結果のサマリーが正しく表示される

### 7.4 保守性

- [ ] 各テストファイルにヘッダーコメントがあり、内容が理解しやすい
- [ ] テストの追加・修正が明確な場所で行える
- [ ] Claudeが各ファイルを読み込んで理解できる

## 8. 未解決の質問

なし（ユーザーの回答により全て解決済み）
