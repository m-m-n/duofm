# 機能要件定義書：コンテキストメニュー

## 機能概要

duofmに`@`キーでコンテキストメニューを表示する機能を追加します。コンテキストメニューは、カーソルで選択中のファイル/ディレクトリに対して実行可能なアクションを一覧表示し、ユーザーがキーボード操作で選択・実行できるようにします。

この機能により、既存のショートカットキー（c, m, dなど）を覚えていなくても、メニューから視覚的にアクションを選択できるようになります。

## 背景と目的

### 背景

現在のduofmでは、ファイル操作（コピー・移動・削除など）はショートカットキーで実行します。しかし、以下の課題があります：

- 初心者がキーバインドを覚える必要がある
- ヘルプダイアログ（`?`）を開かないとキーバインドを確認できない
- 将来的に機能が増えた場合、すべてのキーバインドを覚えるのが困難
- シンボリックリンクの特殊な操作（論理パス vs 物理パス）にアクセスする手段がない

### 目的

1. **操作の発見可能性を向上**: メニューから利用可能なアクションを確認できる
2. **初心者の学習コストを削減**: キーバインドを覚えなくても操作可能
3. **拡張性の確保**: 将来的な機能追加時にメニュー項目を追加するだけで対応可能
4. **シンボリックリンクの高度な操作**: 論理パス/物理パスの選択を可能にする
5. **キーバインドカスタマイズの基盤**: 将来的な設定ファイル対応の準備

## 要求事項

### 機能要件

#### FR1: コンテキストメニューの表示

- **FR1.1**: `@`キーを押すとコンテキストメニューを表示する
- **FR1.2**: メニューは**アクティブペインの中央**にダイアログとして表示する
- **FR1.3**: メニュー表示中は背景（ファイルリスト）を半透明または暗色でオーバーレイする（既存ダイアログと同様）
- **FR1.4**: メニューは角丸ボーダーで囲む（既存ダイアログと同様のスタイル）
- **FR1.5**: 親ディレクトリ（`..`）が選択されている場合、メニューを表示しない

#### FR2: メニューアイテム

初期バージョンでは以下の3つのアクションを含める：

- **FR2.1**: コピー（対向ペインへ）- 既存のcキーと同じ動作
- **FR2.2**: 移動（対向ペインへ）- 既存のmキーと同じ動作
- **FR2.3**: 削除 - 既存のdキーと同じ動作（確認ダイアログ表示）

#### FR3: シンボリックリンクの特別な扱い

シンボリックリンクが選択されている場合：

- **FR3.1**: 通常のアクション（コピー・移動・削除）に加えて以下を追加：
  - **「ディレクトリとして開く（論理パス）」**: リンク先をたどってディレクトリに入る（Enterキーのデフォルト動作）
  - **「リンク先を開く（物理パス）」**: リンク先のディレクトリ/ファイルに直接移動する
- **FR3.2**: リンク切れ（broken link）の場合は「リンク先を開く」を無効化またはグレーアウト表示

#### FR4: メニュー操作

- **FR4.1**: `j`/`k`キーでメニュー項目を上下に移動（既存のカーソル移動と同じ）
- **FR4.2**: `Enter`キーで選択中の項目を実行
- **FR4.3**: `Esc`キーでメニューをキャンセル（閉じる）
- **FR4.4**: `1`-`9`の数字キーで該当する項目を直接選択（1番目～9番目の項目）
- **FR4.5**: `h`/`l`キーでページ移動（10個以上の項目がある場合）
  - `h`: 前ページ
  - `l`: 次ページ

#### FR5: ページネーション（将来拡張用）

10個以上のメニュー項目がある場合：

- **FR5.1**: 1ページあたり9項目を表示
- **FR5.2**: ヘッダーに「Context Menu (1/3)」のようにページ番号を表示
- **FR5.3**: フッターに「h:prev l:next Esc:cancel」のようにナビゲーションヒントを表示
- **FR5.4**: 1-9の数字キーは現在ページの項目のみに適用

#### FR6: キーバインド設計

- **FR6.1**: `@`キーのバインドを`internal/ui/keys.go`に定数として定義（`KeyContextMenu = "@"`）
- **FR6.2**: 将来的な設定ファイル対応を考慮した実装にする（ハードコードしない）
- **FR6.3**: 既存のキー処理（c, m, dなど）と同じパターンで実装

#### FR7: エラーハンドリング

- **FR7.1**: パーミッションエラーは操作実行時に検出し、エラーダイアログで通知（事前チェックしない）
- **FR7.2**: ローディング中（ディレクトリ読み込み中）は既存の実装に従う（メニュー表示の特別な制限なし）

### 非機能要件

#### NFR1: パフォーマンス

- **NFR1.1**: メニュー表示は即座に行われる（100ms以内）
- **NFR1.2**: キー入力への応答は即座に行われる（レンダリング遅延なし）

#### NFR2: ユーザビリティ

- **NFR2.1**: メニュー幅は項目の長さに応じて調整するが、最小40カラム、最大60カラムとする
- **NFR2.2**: 選択中の項目はハイライト表示する（背景色変更）
- **NFR2.3**: 数字キーで選択可能な項目には番号を表示（例: `1. Copy to other pane`）
- **NFR2.4**: メニュー項目は簡潔で分かりやすい表記にする（動詞 + 目的語）

#### NFR3: 一貫性

- **NFR3.1**: 既存のダイアログ（ConfirmDialog, HelpDialogなど）と同じUIパターンを使用
- **NFR3.2**: 既存のキーバインド（j/k/h/l/Enter/Esc）と一貫性を保つ
- **NFR3.3**: エラーメッセージは既存のErrorDialogと同じ形式

#### NFR4: 保守性

- **NFR4.4**: コンテキストメニューはDialogインターフェースを実装
- **NFR4.5**: メニュー項目の定義は容易に追加・変更できる構造にする
- **NFR4.6**: ユニットテストを含める（テーブル駆動テスト）

#### NFR5: 画面サイズ対応

- **NFR5.1**: 推奨最小幅: 80カラム（各ペイン40カラム）
- **NFR5.2**: 最低動作幅: 60カラム（各ペイン30カラム、縮退モード）
- **NFR5.3**: アクティブペイン中央に表示することで、狭い端末でも視認性を確保

## 制約事項

### 技術的制約

1. **既存アーキテクチャへの準拠**: Bubble TeaのThe Elm Architectureに従う
2. **既存ダイアログパターンの使用**: `Dialog`インターフェースを実装し、`model.dialog`で管理
3. **キーバインド定数化**: `keys.go`で定義し、将来の設定ファイル対応に備える

### スコープ外

以下は初期バージョンでは実装しない（将来拡張として記載）：

1. **複数ファイル選択対応**: マーク機能実装後に対応
2. **キーバインドのカスタマイズ**: 設定ファイル対応は将来実装
3. **追加のアクション**: 名前変更、新規作成、パーミッション変更など
4. **サブメニュー**: 階層的なメニュー構造

### 制限事項

1. **親ディレクトリへの操作禁止**: `..`エントリが選択されている場合はメニューを表示しない
2. **ページネーション制限**: 初期バージョンでは3-5個のアイテムのみなので、実質的にページネーション不要

## 成功基準

### 機能的成功基準

1. `@`キーでコンテキストメニューが表示される
2. メニューから「コピー」「移動」「削除」が実行できる
3. シンボリックリンクの場合、「リンク先を開く」が表示され、実行できる
4. j/k/Enter/Escキーでメニューを操作できる
5. 1-9の数字キーで項目を直接選択できる
6. 親ディレクトリ選択時にメニューが表示されない

### 品質的成功基準

1. 既存のユニットテストがすべてパスする
2. 新規追加コードのテストカバレッジが80%以上
3. メニュー表示・操作のレスポンスが即座（体感100ms以内）
4. 既存ダイアログと一貫したUIデザイン

### ユーザー体験の成功基準

1. 初心者がキーバインドを知らなくても`@`キーからアクションを発見できる
2. メニュー操作が直感的（ヘルプなしで使える）
3. シンボリックリンクの論理パス/物理パスの違いが理解できる

## 将来の拡張

以下は将来のバージョンで検討する拡張機能：

1. **マーク機能との連携**: 複数ファイル選択時のバッチ操作
2. **追加アクション**:
   - 名前変更
   - 新規ディレクトリ/ファイル作成
   - パーミッション変更
   - 属性情報表示
   - アーカイブ作成/展開
3. **キーバインドカスタマイズ**: TOML/YAML設定ファイルからの読み込み
4. **サブメニュー**: 階層的なメニュー構造（例: コピー → 名前を付けてコピー）
5. **プラグインシステム**: カスタムアクションの追加

## 参考資料

- 既存実装:
  - `/home/sakura/go/src/duofm/internal/ui/dialog.go` - Dialogインターフェース
  - `/home/sakura/go/src/duofm/internal/ui/confirm_dialog.go` - 確認ダイアログの実装例
  - `/home/sakura/go/src/duofm/internal/ui/help_dialog.go` - ヘルプダイアログの実装例
  - `/home/sakura/go/src/duofm/internal/ui/keys.go` - キーバインド定義
  - `/home/sakura/go/src/duofm/internal/ui/model.go` - メインモデルとキーハンドリング
