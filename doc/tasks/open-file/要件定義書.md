# ファイルを開く機能 - 要件定義書

## 概要

duofmでファイルを選択した際に、外部アプリケーション（viewer/editor）を起動してファイルを開く機能を実装する。

## ビジネス要件

### 目的
- ファイルマネージャーとして、ファイルの閲覧・編集をシームレスに行えるようにする
- キーボード操作のみで素早くファイルを開けるようにする

### 対象ユーザー
- ターミナルベースのワークフローを好むユーザー
- vim/lessなどのCLIツールに慣れているユーザー

## ユースケース

### UC-1: ファイルをビューアーで開く
**アクター**: ユーザー
**事前条件**: ファイルが選択されている
**基本フロー**:
1. ユーザーが `v` キーまたは `Enter` キーを押す
2. duofmの画面が一時的に隠れる
3. lessでファイルが開かれる
4. ユーザーがlessを終了する
5. duofmの画面が復帰する
6. ファイル一覧が自動的に再読み込みされる

### UC-2: ファイルをエディタで開く
**アクター**: ユーザー
**事前条件**: ファイルが選択されている
**基本フロー**:
1. ユーザーが `e` キーを押す
2. duofmの画面が一時的に隠れる
3. vimでファイルが開かれる
4. ユーザーがvimを終了する
5. duofmの画面が復帰する
6. ファイル一覧が自動的に再読み込みされる

## 機能要件

### FR-1: キーバインディング

| キー | 対象 | 動作 |
|------|------|------|
| `v` | ファイル | lessで開く |
| `v` | ディレクトリ | 何もしない（無視） |
| `e` | ファイル | vimで開く |
| `e` | ディレクトリ | 何もしない（無視） |
| `Enter` | ファイル | lessで開く（vと同じ） |
| `Enter` | ディレクトリ | ディレクトリに入る（既存動作） |

### FR-2: 外部アプリケーション起動

- **ビューアー**: `less` コマンド
- **エディタ**: `vim` コマンド
- 起動時にduofmの画面は一時的に非表示になる
- 外部アプリ終了後、duofmの画面が復帰する

### FR-3: ファイル一覧の再読み込み

- 外部アプリケーション終了後、アクティブペインと非アクティブペインの両方を自動的に再読み込みする
- これにより、vimでの編集結果（新規ファイル作成など）が即座に反映される

### FR-4: エラーハンドリング

| 状況 | 動作 |
|------|------|
| ファイルの読み取り権限がない | ステータスバーにエラーメッセージを表示 |
| less/vimが見つからない | 起動を試みて失敗する（シェルのエラーがそのまま表示される） |
| 親ディレクトリエントリ(..)選択時 | 何もしない（無視） |

## 非機能要件

### NFR-1: レスポンス
- キー入力から外部アプリ起動まで100ms以内

### NFR-2: 画面復帰
- 外部アプリ終了後、100ms以内にduofmの画面が完全に復帰する

## UI/UX要件

### UIの変更点
- ステータスバーのキーヒントに `v:view e:edit` を追加（オプション）

### 画面遷移

```
duofm画面 → [v/e/Enter] → 外部アプリ画面 → [q等で終了] → duofm画面（再読み込み済み）
```

## データ要件

### 状態管理
- 特別な状態管理は不要
- 外部アプリ起動中はBubble Teaのプログラムが一時停止される

## 制約条件

### 今回の実装範囲
- ビューアー: `less` 固定
- エディタ: `vim` 固定

### 将来的な拡張（今回は実装しない）
- 設定ファイルでビューアー/エディタを指定可能にする
- mime typeに基づいてアプリケーションを選択する
- ファイル拡張子に基づいてアプリケーションを選択する

## 成功基準

- [ ] `v` キーでファイルがlessで開ける
- [ ] `e` キーでファイルがvimで開ける
- [ ] `Enter` キーでファイルがlessで開ける
- [ ] ディレクトリ選択時は `v`/`e` キーが無視される
- [ ] `Enter` キーでディレクトリに入る動作は維持される
- [ ] 外部アプリ終了後にファイル一覧が自動更新される
- [ ] 読み取り権限がないファイルでエラーメッセージが表示される
- [ ] 全ての既存機能が正常に動作する

## テストシナリオ

### TS-1: 基本動作テスト
1. テキストファイルを選択して `v` を押す → lessで開く
2. テキストファイルを選択して `e` を押す → vimで開く
3. テキストファイルを選択して `Enter` を押す → lessで開く
4. ディレクトリを選択して `Enter` を押す → ディレクトリに入る

### TS-2: ディレクトリでのキー無視テスト
1. ディレクトリを選択して `v` を押す → 何も起きない
2. ディレクトリを選択して `e` を押す → 何も起きない

### TS-3: 親ディレクトリエントリテスト
1. `..` を選択して `v` を押す → 何も起きない
2. `..` を選択して `e` を押す → 何も起きない
3. `..` を選択して `Enter` を押す → 親ディレクトリに移動

### TS-4: エラーハンドリングテスト
1. 読み取り権限のないファイルを選択して `v` を押す → ステータスバーにエラー表示
2. 読み取り権限のないファイルを選択して `e` を押す → ステータスバーにエラー表示

### TS-5: 画面復帰テスト
1. ファイルを開いて終了 → duofmの画面が正しく復帰
2. ファイルを編集して保存して終了 → 変更がファイル一覧に反映

## 確認済み事項

| 項目 | 確認内容 |
|------|----------|
| ディレクトリでのv/eキー | 何もしない（無視） |
| 外部アプリ終了後の再読み込み | 常に再読み込みする |
| 読み取り権限エラー | ステータスバーにエラー表示 |
| less/vim未インストール | 起動を試みて失敗する |
| 今回の実装スコープ | 基本機能のみ（設定ファイル、mime type対応は将来） |
