# 要件定義書: 非同期ディレクトリ読み込み時のペイン識別バグ修正

## 概要

非同期ディレクトリ読み込み完了時（`directoryLoadCompleteMsg`）のペイン判定ロジックに問題があり、両ペインが同じパスを表示している状態でナビゲーションを行うと、右ペインが「Loading directory...」のまま停止するバグを修正する。

## 問題の詳細

### 現象
- 右ペインでホームディレクトリに戻ろうとすると、ツールバーが「Loading directory...」のまま停止し、ナビゲーションが完了しない

### 再現手順
1. duofm をホームディレクトリから起動（左右両ペインがホームディレクトリ）
2. `l` キーで右ペインに切り替え
3. `l` キーで親ディレクトリ (`/home`) に移動
4. ホームディレクトリに戻ろうとする（`~`キー、Enter、または`-`キー）
5. **バグ発生**: ツールバーが「Loading directory...」のまま停止

### 根本原因
`directoryLoadCompleteMsg` のペイン判定ロジックが、パスの一致のみで判定している。両ペインが同じパスを持つ場合、常に左ペインが選択され、右ペインの `loading` フラグがクリアされない。

## 目的

- 非同期ディレクトリ読み込み完了時に、正しいペインが確実に識別されるようにする
- 両ペインが同じパスを表示している場合でも、正しく動作することを保証する

## ドメインルール

- **DR-1**: 各非同期ディレクトリ読み込み操作は、開始したペインに対してのみ完了処理を適用しなければならない
- **DR-2**: ペインの識別はパスではなく、明示的なペイン識別子によって行われなければならない
- **DR-3**: 両ペインが同じパスを表示している状態でも、各ペインの状態は独立して管理されなければならない

## ユーザーストーリー

### US-1: 右ペインでのホームディレクトリナビゲーション
**ユーザーとして**、右ペインでホームディレクトリに移動したとき、
**期待すること**、ディレクトリが正常に読み込まれ表示される、
**理由**：左ペインが同じパスを表示していても影響を受けないようにするため。

### US-2: 前のディレクトリへの戻り操作
**ユーザーとして**、`-`キーで前のディレクトリに戻るとき、
**期待すること**、操作を行ったペインでディレクトリが正常に読み込まれる、
**理由**：前のディレクトリが他方のペインと同じでも正常に動作するため。

## 機能要件

### FR-1: ペイン識別子の追加
- FR-1.1: `directoryLoadCompleteMsg` にペイン識別子（`PaneType`）フィールドを追加する
- FR-1.2: ペイン識別子は `LeftPane` または `RightPane` の値を持つ

### FR-2: 非同期読み込み開始時のペイン識別子設定
- FR-2.1: `LoadDirectoryAsync()` を呼び出す全ての箇所で、呼び出し元のペインを識別する情報を渡す
- FR-2.2: 非同期処理の完了メッセージにペイン識別子を含める

### FR-3: 完了メッセージのペイン判定ロジック変更
- FR-3.1: `directoryLoadCompleteMsg` のハンドラは、パスではなくペイン識別子に基づいて対象ペインを決定する
- FR-3.2: ペイン識別子が `LeftPane` の場合は左ペインを対象とする
- FR-3.3: ペイン識別子が `RightPane` の場合は右ペインを対象とする

## 非機能要件

### NFR-1: 後方互換性
- NFR-1.1: 既存のナビゲーション機能の動作を変更しない
- NFR-1.2: 既存のキーバインディングを変更しない

### NFR-2: パフォーマンス
- NFR-2.1: 追加されるペイン識別子の処理は、キーレスポンス時間（50ms以内）に影響を与えない

## インターフェース契約

### 入出力仕様

#### directoryLoadCompleteMsg（変更後）
```
入力フィールド:
- paneID: PaneType (LeftPane | RightPane) - 対象ペインの識別子
- panePath: string - 読み込み対象のパス
- entries: []fs.FileEntry - 読み込まれたエントリ
- err: error - エラー情報（成功時はnil）
- attemptedPath: string - エラー時に表示するパス

出力:
- 対象ペインの状態更新
- エラー時はステータスバーにメッセージ表示
```

### 状態遷移

```
読み込み開始:
  ペイン.loading = true
  ペイン.pendingPath = 対象パス

読み込み完了（成功）:
  ペイン.loading = false
  ペイン.pendingPath = ""
  ペイン.entries = 読み込まれたエントリ

読み込み完了（失敗）:
  ペイン.loading = false
  ペイン.restorePreviousPath()
  ステータスバー = エラーメッセージ
```

## テストシナリオ

### 基本シナリオ
- [ ] TS-1: 左ペインの非同期ディレクトリ読み込みが正常に完了する
- [ ] TS-2: 右ペインの非同期ディレクトリ読み込みが正常に完了する

### 両ペイン同一パスシナリオ
- [ ] TS-3: 両ペインがホームディレクトリを表示している状態で、右ペインが親ディレクトリに移動後、ホームに戻る
- [ ] TS-4: 両ペインが同じディレクトリを表示している状態で、左ペインでナビゲーションを行う
- [ ] TS-5: 右ペインで`~`キーを使用してホームディレクトリに移動する（左ペインがホームディレクトリ表示中）
- [ ] TS-6: 右ペインで`-`キーを使用して前のディレクトリに戻る（前のディレクトリが左ペインと同じ）

### エラーシナリオ
- [ ] TS-7: 存在しないディレクトリへの非同期ナビゲーション時、エラーが正しいペインに適用される
- [ ] TS-8: 権限のないディレクトリへの非同期ナビゲーション時、エラーが正しいペインに適用される

## 成功基準

- [ ] SC-1: 再現手順に従った操作で、右ペインが正常にホームディレクトリを表示する
- [ ] SC-2: 両ペインが同じパスを表示している状態でも、各ペインが独立してナビゲーションできる
- [ ] SC-3: 既存の単体テストがすべてパスする
- [ ] SC-4: 新規追加のテストがすべてパスする

## 影響範囲

### 変更対象ファイル
- `internal/ui/messages.go`: `directoryLoadCompleteMsg` 構造体の変更
- `internal/ui/pane.go`: 非同期読み込み関数の変更
- `internal/ui/model.go`: メッセージハンドラの変更

### 影響を受ける機能
- `NavigateToHomeAsync()` - ホームディレクトリへの非同期ナビゲーション
- `NavigateToPreviousAsync()` - 前のディレクトリへの非同期ナビゲーション
- `MoveToParentAsync()` - 親ディレクトリへの非同期移動
- `EnterDirectoryAsync()` - サブディレクトリへの非同期移動
- `LoadDirectoryAsync()` - ディレクトリの非同期読み込み

## 制約事項

- 既存のAPIを変更する必要があるため、関連する全ての呼び出し箇所を更新する必要がある
- 非同期処理のコールバックにペイン情報を渡す必要がある
