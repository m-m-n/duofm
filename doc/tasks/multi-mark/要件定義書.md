# 要件定義書: 複数ファイルマーク機能

## 概要

複数のファイルを選択（マーク）し、一括でファイル操作（コピー、移動、削除）を行える機能を追加する。

## 目的

- 複数ファイルの効率的な一括操作
- ファイル選択状態の視覚的フィードバック
- 既存の単一ファイル操作との整合性維持

## 背景

現在のduofmでは、ファイル操作（コピー、移動、削除）は1ファイルずつ行う必要がある。多くのファイルを操作する際に効率が悪い。Midnight Commander（mc）やその他のデュアルペインファイルマネージャーと同様に、複数ファイルを選択して一括操作できるようにする。

## ユーザーストーリー

1. **ユーザーとして**、Spaceキーでファイルを1つずつマークしたい。それにより、複数ファイルを選択できる。

2. **ユーザーとして**、マークされたファイルを視覚的に区別したい。それにより、どのファイルが選択されているか把握できる。

3. **ユーザーとして**、マークしたファイルを一括でコピー/移動/削除したい。それにより、効率的にファイル操作ができる。

4. **ユーザーとして**、ヘッダーでマーク数と合計サイズを確認したい。それにより、選択状態を把握できる。

## 機能要件

### FR1: マーク操作

| ID | 要件 | 優先度 |
|----|------|--------|
| FR1.1 | 未マークのファイルでSpaceキーを押すとマークされる | 必須 |
| FR1.2 | マーク済みのファイルでSpaceキーを押すとマークが解除される | 必須 |
| FR1.3 | マーク/解除後、カーソルを1つ下に移動 | 必須 |
| FR1.4 | 親ディレクトリ（..）はマーク不可（Spaceで何も起こらない） | 必須 |
| FR1.5 | マーク状態は各ペインで独立して管理 | 必須 |
| FR1.6 | ディレクトリ移動時にマークをクリア | 必須 |

### FR2: 視覚的表示

| ID | 要件 | 優先度 |
|----|------|--------|
| FR2.1 | マークされたファイルは背景色を変えて表示 | 必須 |
| FR2.2 | カーソル位置のファイルがマークされている場合も区別可能 | 必須 |
| FR2.3 | アクティブペインとインアクティブペインで色を区別 | 必須 |

### FR3: ヘッダー表示

| ID | 要件 | 優先度 |
|----|------|--------|
| FR3.1 | 「Marked X/Y Z MiB」形式でマーク情報を表示 | 必須 |
| FR3.2 | Xはマーク数、Yは総ファイル数（親ディレクトリを除く） | 必須 |
| FR3.3 | Zはマークされたファイルの合計サイズ | 必須 |
| FR3.4 | ディレクトリがマークされている場合、サイズは0扱い | 必須 |

### FR4: ファイル操作との連携

| ID | 要件 | 優先度 |
|----|------|--------|
| FR4.1 | マークがある場合、c/m/dはマークされたファイルに適用 | 必須 |
| FR4.2 | マークがない場合、c/m/dはカーソル位置のファイルに適用（既存動作） | 必須 |
| FR4.3 | 操作完了後、マークをクリア | 必須 |
| FR4.4 | 複数ファイル操作中に上書き確認が発生した場合の対応 | 必須 |

### FR5: 複数ファイル操作時の上書き確認

| ID | 要件 | 優先度 |
|----|------|--------|
| FR5.1 | 既存の上書き確認ダイアログを使用 | 必須 |
| FR5.2 | ファイルごとに確認 | 必須 |
| FR5.3 | キャンセル時は残りのファイルも処理を中断 | 必須 |

## 非機能要件

### NFR1: パフォーマンス

| ID | 要件 |
|----|------|
| NFR1.1 | マーク操作は即座に反映（50ms以内） |
| NFR1.2 | 1000ファイルマークしても描画が遅延しない |
| NFR1.3 | マーク情報（数、サイズ）の計算は効率的に行う |

### NFR2: 一貫性

| ID | 要件 |
|----|------|
| NFR2.1 | 既存のキーバインディングと衝突しない |
| NFR2.2 | 他のダイアログ系機能と一貫した操作感 |
| NFR2.3 | コンテキストメニューからの操作もマークファイルに対応 |

## UI設計

### マーク表示（背景色）

```
マーク前:
  README.md          1.2 KiB  2024-12-01
  notes.txt          450 B    2024-11-28
  image.png          2.3 MiB  2024-12-10

マーク後（背景色でハイライト）:
  README.md          1.2 KiB  2024-12-01    ← 背景色変更
  notes.txt          450 B    2024-11-28
  image.png          2.3 MiB  2024-12-10    ← 背景色変更
```

### 色設計

| 状態 | アクティブペイン | インアクティブペイン |
|------|------------------|----------------------|
| 通常 | デフォルト背景 | デフォルト背景 |
| カーソル | 青背景(#39) | グレー背景(#240) |
| マーク | 黄色背景(#136) | 暗い黄色背景(#94) |
| カーソル+マーク | シアン背景(#30) | 暗いシアン背景(#23) |

### ヘッダー表示例

```
マークなし:
  Marked 0/15 0 B                         10.5 GiB Free

3ファイルマーク（合計1.5 MiB）:
  Marked 3/15 1.5 MiB                     10.5 GiB Free

フィルタ適用中（5件表示中、うち2件マーク）:
  Marked 2/5 (15) 500 KiB                 10.5 GiB Free
```

## キーバインディング

| キー | 動作 |
|------|------|
| Space | 現在のファイルのマーク状態を切り替え、カーソルを1つ下に移動 |

## データ構造

### Pane構造体への追加

```go
type Pane struct {
    // 既存フィールド...

    // マーク管理用
    markedFiles map[string]bool  // キー: ファイル名, 値: マーク状態
}
```

### マーク情報の計算

```go
type MarkInfo struct {
    Count     int   // マークされたファイル数
    TotalSize int64 // マークされたファイルの合計サイズ
}

func (p *Pane) CalculateMarkInfo() MarkInfo
```

## エッジケース

| ケース | 動作 |
|--------|------|
| 親ディレクトリ(..)でSpace | 何もしない（カーソルも移動しない） |
| 最後のファイルでSpace | マーク切り替え後、カーソルは最後のファイルのまま |
| 隠しファイル表示切り替え | 非表示になったファイルのマークはクリア |
| フィルタ適用 | フィルタ後もマーク状態は維持（表示されないファイルも） |
| ディレクトリ移動 | すべてのマークをクリア |
| リフレッシュ（F5） | マークは維持（ファイルが存在する場合） |
| ファイル削除後のリフレッシュ | 削除されたファイルのマークは自動クリア |

## テストケース

### 単体テスト

1. **マーク操作**
   - 未マークのファイルでSpaceを押すとマークされる
   - マーク済みのファイルでSpaceを押すとマークが解除される
   - マーク/解除後にカーソルが下に移動する
   - 親ディレクトリでSpaceは無視される（マークされず、カーソルも移動しない）

2. **マーク情報計算**
   - マーク数が正しく計算される
   - 合計サイズが正しく計算される
   - ディレクトリのサイズは0として扱われる

3. **表示**
   - マークファイルの背景色が変更される
   - ヘッダーのマーク情報が正しく表示される

### 統合テスト

1. **ファイル操作連携**
   - マークファイルのコピーが正しく動作する
   - マークファイルの移動が正しく動作する
   - マークファイルの削除が正しく動作する
   - 操作後にマークがクリアされる

2. **上書き確認**
   - 複数ファイルコピー時に上書き確認が順次表示される
   - キャンセル時に残りの処理が中断される

## 依存関係

### 前提

- 既存の単一ファイル操作（コピー、移動、削除）
- 上書き確認ダイアログ（overwrite-confirmation）

### 影響を受けるコンポーネント

- `internal/ui/pane.go`: マーク管理、表示
- `internal/ui/model.go`: ファイル操作のマーク対応
- `internal/ui/keys.go`: Spaceキーバインド追加
- `internal/ui/context_menu_dialog.go`: コンテキストメニューのマーク対応

## 成功基準

- [ ] Spaceキーでファイルをマーク/解除できる
- [ ] マークされたファイルが視覚的に区別できる
- [ ] ヘッダーでマーク数と合計サイズが確認できる
- [ ] マークファイルに対して一括コピー/移動/削除ができる
- [ ] 既存の単一ファイル操作が正しく動作する
- [ ] 上書き確認が正しく動作する
- [ ] すべての既存テストがパスする

---

*作成日: 2024-12-24*
