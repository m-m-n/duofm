# 要件定義書: コンテキストメニューのCompress機能バグ修正

**作成日**: 2026-01-02
**ステータス**: 確定
**種別**: バグ修正

---

## 1. 概要

### 1.1 問題の説明

コンテキストメニュー（`@`キー）からファイル/ディレクトリを選択し「Compress」オプションを選択しても、何も起きない（フォーマット選択ダイアログが表示されない）バグが発生している。

### 1.2 再現手順

1. duofmを起動
2. ファイルまたはディレクトリを選択
3. `@`キーでコンテキストメニューを開く
4. 「Compress」（または「Compress N files」）を選択
5. **期待**: フォーマット選択ダイアログ（CompressFormatDialog）が表示される
6. **実際**: 何も起きず、通常状態に戻る

### 1.3 影響範囲

- 単一ファイル/ディレクトリの圧縮機能
- 複数マークファイルの一括圧縮機能
- アーカイブ機能の主要ユースケースが使用不可

---

## 2. 根本原因分析

### 2.1 問題のコード

**ファイル**: `internal/ui/context_menu_dialog.go` (171-181行)
```go
items = append(items, MenuItem{
    ID:      "compress",
    Label:   compressLabel,
    Action:  nil, // ← 問題: Action が nil
    Enabled: true,
})
```

**ファイル**: `internal/ui/model.go` (156-196行)
```go
if result, ok := msg.(contextMenuResultMsg); ok {
    // ...
    if result.action != nil {  // ← 問題: compress の action は nil なのでここに入らない
        // ...
        if result.actionID == "compress" {  // ← 到達しない
            m.dialog = NewCompressFormatDialog()
            return m, nil
        }
        // ...
    }
}
```

### 2.2 原因

1. `context_menu_dialog.go` で "compress" メニュー項目を作成する際、`Action` フィールドが `nil` に設定されている
2. `model.go` で `contextMenuResultMsg` を処理する際、`result.action != nil` の条件判定がある
3. compress の `action` は `nil` なので、この条件を満たさず、compress 処理に到達しない
4. 結果として `NewCompressFormatDialog()` が呼び出されない

### 2.3 なぜ他のメニュー項目は動作するのか

- **Delete**: `Action` が `nil` だが、`result.actionID == "delete"` のチェックは `result.action != nil` ブロック内にあるため、同様に動作しないはず（要確認）
- **Extract**: `Action` にダミー関数が設定されているため、条件を通過できる
- **Copy/Move**: 同様に `Action` にダミー関数が設定されている

---

## 3. 要件

### 3.1 機能要件

| ID | 要件 | 優先度 |
|----|------|--------|
| FR-1 | コンテキストメニューから「Compress」を選択した場合、CompressFormatDialogが表示されること | 必須 |
| FR-2 | 複数ファイルマーク時に「Compress N files」を選択した場合も同様に動作すること | 必須 |
| FR-3 | 他のコンテキストメニュー項目（Delete, Copy, Move等）の動作に影響を与えないこと | 必須 |

### 3.2 非機能要件

| ID | 要件 | 優先度 |
|----|------|--------|
| NFR-1 | 修正は最小限の変更で行い、既存コードへの影響を最小化すること | 必須 |
| NFR-2 | 修正後、既存のテストがすべてパスすること | 必須 |

---

## 4. 修正方針

### 4.1 方針A: model.go の条件分岐を修正（推奨）

`compress` と `delete` の処理を `result.action != nil` の条件の**外側**に移動する。

**修正箇所**: `internal/ui/model.go` (156-237行付近)

**理由**:
- 最小限の変更で済む
- 論理的にも正しい（actionID ベースで処理を振り分けるべき）
- extract, enter_logical も actionID ベースで処理されるべき

### 4.2 方針B: context_menu_dialog.go で Action を設定

`compress` メニュー項目にダミーの Action 関数を設定する。

**理由**:
- 既存の extract と同様のパターン
- model.go の変更不要

**採用**: 方針A（論理的に正しく、将来のメンテナンスが容易）

---

## 5. 受け入れ基準

1. [ ] コンテキストメニューから「Compress」を選択すると、CompressFormatDialogが表示される
2. [ ] 複数ファイルマーク時に「Compress N files」を選択しても正しく動作する
3. [ ] Delete, Copy, Move, Extract などの他のメニュー項目が正常に動作する
4. [ ] 既存のテストがすべてパスする
5. [ ] 新しいテストケースで修正が検証される

---

## 6. 関連ドキュメント

- **既存仕様書**: `doc/tasks/archive/SPEC.md`
- **既存実装計画**: `doc/tasks/archive/IMPLEMENTATION.md`
- **既存検証レポート**: `doc/tasks/archive/VERIFICATION_REPORT_FINAL.md`

---

## 7. 履歴

| 日付 | 変更内容 | 担当者 |
|------|----------|--------|
| 2026-01-02 | 初版作成 | - |
