# 要件定義書: シェルコマンド実行機能

## 概要

duofm内から任意のシェルコマンドを実行する機能を追加する。ユーザーは`!`キーを押してコマンドを入力し、外部シェルで実行できる。実行時のカレントディレクトリはアクティブペインのディレクトリに設定される。

## 背景・目的

ファイルマネージャーでファイル操作を行う際、ターミナルに戻って追加のコマンドを実行したい場面が頻繁にある（例：git status、tar、grep等）。この機能により、duofmから離れることなくシェルコマンドを実行でき、ワークフローが効率化される。

## ユーザーストーリー

- ユーザーとして、`!`キーを押してコマンド入力欄を表示し、任意のシェルコマンドを実行したい
- ユーザーとして、コマンド実行時にアクティブペインのディレクトリをカレントディレクトリとして使用したい
- ユーザーとして、コマンド実行結果を確認してから「Press Enter to continue...」でduofmに戻りたい

## 機能要件

### FR-1: コマンド入力

| 項目 | 内容 |
|------|------|
| トリガー | `!`キーを押す |
| 入力UI | 画面下部にミニバッファ（コマンドライン）を表示 |
| プロンプト | `!` |
| 文字入力 | 任意の文字（スペースを含む）をコマンド文字列に追加 |
| キャンセル | `Escape`キーで入力をキャンセルしてファイル一覧に戻る |
| 実行 | `Enter`キーでコマンドを実行 |

**技術的注意:** Bubble Teaではスペースキーは`tea.KeyRunes`ではなく`tea.KeySpace`タイプとして報告されるため、ミニバッファで明示的に処理する必要がある。これにより`ls -la`や`echo hello world`のようなスペースを含むコマンドが入力可能になる。

### FR-2: コマンド実行

| 項目 | 内容 |
|------|------|
| 実行方法 | シェル(`/bin/sh -c`)を介してコマンドを実行 |
| 作業ディレクトリ | アクティブペインの現在のディレクトリ |
| 画面制御 | duofmを一時停止し、ターミナル画面をシェルに明け渡す |

### FR-3: 実行後の動作

| 項目 | 内容 |
|------|------|
| 待機メッセージ | コマンド終了後に「Press Enter to continue...」を表示 |
| 復帰操作 | `Enter`キーでduofmに復帰 |
| ペイン更新 | 復帰時に両ペインのディレクトリ内容をリロード |

### FR-4: エラーハンドリング

| 状況 | 動作 |
|------|------|
| 空のコマンド | 何もせずに入力モードを終了 |
| コマンド実行エラー | シェルがエラーを表示（duofmでは特別な処理をしない） |

## 非機能要件

### NFR-1: 一貫性

- 既存の`v`（viewer）、`e`（editor）キーによる外部コマンド実行と同様の仕組みを使用
- Bubble Teaの`tea.ExecProcess`を使用してTUIを一時停止

### NFR-2: ユーザビリティ

- ミニバッファは既存の検索機能（`/`キー）と同様のUIを使用
- `!`キーは伝統的なファイルマネージャー（FD、MC等）と同じキーバインド

## 制約事項

- 対話的なコマンド（例：top、htop）はサポートするが、特別な対応はしない（ユーザーの責任で使用）
- コマンド履歴機能は本機能のスコープ外
- 環境変数の設定機能は本機能のスコープ外

## UI仕様

### コマンド入力モード

```
┌─ /home/user/documents ─────────┐┌─ /home/user/downloads ─────────┐
│ ..                             ││ ..                             │
│ file1.txt                      ││ image.png                      │
│ file2.txt                      ││ video.mp4                      │
│                                ││                                │
├────────────────────────────────┴┴────────────────────────────────┤
│ !ls -la                                                          │
└──────────────────────────────────────────────────────────────────┘
```

### 実行後待機画面

```
$ ls -la
total 12
drwxr-xr-x  2 user user 4096 Dec 28 10:00 .
drwxr-xr-x 10 user user 4096 Dec 28 09:00 ..
-rw-r--r--  1 user user  100 Dec 28 10:00 file1.txt
-rw-r--r--  1 user user  200 Dec 28 10:00 file2.txt

Press Enter to continue...
```

## 受け入れ条件

1. `!`キーでコマンド入力モードに入れること
2. 入力したコマンドが実行されること
3. 実行時のカレントディレクトリがアクティブペインのディレクトリであること
4. 「Press Enter to continue...」が表示され、Enterキーでduofmに復帰できること
5. 復帰時に両ペインの内容が更新されること
6. `Escape`キーでコマンド入力をキャンセルできること
7. 空のコマンドの場合は何も実行されないこと
