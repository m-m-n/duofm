# 要件定義書: 親ディレクトリ遷移時のカーソル位置記憶

## 1. 概要

親ディレクトリに遷移した際、直前まで居たサブディレクトリにカーソルを自動的に合わせる機能を実装する。

### 1.1 背景

多くのファイルマネージャー（Ranger、Midnight Commanderなど）では、親ディレクトリに戻った際に直前まで居たサブディレクトリが選択された状態になる。これはユーザーが「どこから来たか」を把握しやすく、ナビゲーションの効率を向上させる一般的なUXパターンである。

現在のduofmでは、親ディレクトリに移動するとカーソルが常にリストの先頭にリセットされるため、元のサブディレクトリを探し直す必要がある。

### 1.2 目的

- 親ディレクトリへの遷移時にユーザーの現在位置を視覚的に維持する
- ディレクトリ階層の上下移動を効率化する
- 一般的なファイルマネージャーのUXに準拠する

## 2. 機能要件

### 2.1 基本動作

#### FR-1: 親ディレクトリ遷移時のカーソル位置

| 条件 | 動作 |
|------|------|
| 親ディレクトリに遷移する | 直前まで居たサブディレクトリにカーソルを合わせる |
| 該当サブディレクトリが存在しない | カーソルをリストの先頭に合わせる |

#### FR-2: 適用される操作

以下の操作すべてに適用する:

| 操作 | 説明 |
|------|------|
| `..`（親ディレクトリエントリ）を選択してEnter | エントリ経由での親ディレクトリ移動 |
| `h`キーまたは`←`キー（左ペインがアクティブ時） | キーバインド経由での親ディレクトリ移動 |
| `l`キーまたは`→`キー（右ペインがアクティブ時） | キーバインド経由での親ディレクトリ移動 |

#### FR-3: ペイン独立動作

- 左右のペインで独立して動作する
- 左ペインの移動履歴は左ペインのみに適用
- 右ペインの移動履歴は右ペインのみに適用

### 2.2 カーソル位置の決定

#### FR-4: サブディレクトリの検索

- ファイル名（ディレクトリ名）ベースで検索する
- ソート順に関係なく、該当するサブディレクトリを見つける
- 隠しファイル表示設定の影響を受ける（非表示の場合は検索対象外）

#### FR-5: カーソル位置が見つからない場合

以下の場合はカーソルをリストの先頭（インデックス0）に設定する:
- サブディレクトリが削除されている
- 隠しファイル表示がOFFで、サブディレクトリが隠しディレクトリである
- その他の理由で該当ディレクトリが一覧に存在しない

## 3. 非機能要件

### 3.1 パフォーマンス要件

| 項目 | 要件 |
|------|------|
| カーソル位置の決定 | 既存のディレクトリ読み込みと同等の時間内で完了 |
| メモリ使用量 | 追加メモリ使用は最小限（直前のディレクトリ名のみ保持） |

### 3.2 互換性要件

- 既存のナビゲーション機能に影響を与えない
- 既存のキーバインドを変更しない
- 新規キーバインドの追加は不要

## 4. UI/UX要件

### 4.1 自動動作

- ユーザーによる明示的な操作は不要
- 親ディレクトリへの移動時に自動的にカーソル位置を決定

### 4.2 視覚的フィードバック

- 特別なインジケーターは不要
- 標準のカーソル表示で十分

## 5. 技術的要件

### 5.1 影響を受けるコンポーネント

| ファイル | 変更内容 |
|---------|---------|
| `internal/ui/pane.go` | 親ディレクトリ移動時のカーソル位置決定ロジック追加 |

### 5.2 実装方針

親ディレクトリへの移動を行うメソッドで、移動前のディレクトリ名を記憶し、移動後のディレクトリ一覧から該当ディレクトリを検索してカーソルを設定する。

対象メソッド:
- `EnterDirectory()` - `..`エントリ経由の場合
- `EnterDirectoryAsync()` - `..`エントリ経由の非同期版
- `MoveToParent()` - キーバインド経由
- `MoveToParentAsync()` - キーバインド経由の非同期版

## 6. テスト要件

### 6.1 単体テスト

- [ ] 親ディレクトリ移動時に直前のサブディレクトリにカーソルが合う
- [ ] サブディレクトリが存在しない場合はカーソルが先頭になる
- [ ] 左右のペインで独立して動作する
- [ ] `..`エントリ経由でもキーバインド経由でも同じ動作をする

### 6.2 統合テスト

- [ ] 複数回のディレクトリ上下移動で正しく動作する
- [ ] ソート順を変更しても正しいサブディレクトリにカーソルが合う
- [ ] 隠しファイル表示OFF時に隠しサブディレクトリから戻ると先頭になる

## 7. 成功基準

- [ ] 親ディレクトリへの移動時に直前のサブディレクトリにカーソルが合う
- [ ] 該当サブディレクトリが存在しない場合は先頭にカーソルが合う
- [ ] 左右のペインで独立して動作する
- [ ] 既存の機能に影響を与えない
- [ ] すべてのテストがパスする

## 8. 制約事項

- 親ディレクトリへの移動のみが対象（任意のディレクトリへの移動は対象外）
- 履歴は1階層分のみ（スタック形式の履歴管理は対象外）
- 設定ファイルへの永続化は対象外
