# 要件定義書: ディレクトリアクセスエラー時の挙動修正

## 概要

読み取り権限のないディレクトリや、何らかの理由でアクセスできないディレクトリに移動しようとしたときの挙動を修正する。現状では、アクセスに失敗してもパスが更新されてしまい、UI上のカレントディレクトリ表示に不整合が生じる問題がある。

## 背景・問題点

### 現状の問題

1. **パスとディレクトリ内容の不整合**
   - ディレクトリに入ろうとすると、読み込み成功/失敗に関わらずパスが先に更新される
   - 読み込みに失敗しても、ペイン上部のカレントディレクトリ表示は移動先を指す
   - 実際にはディレクトリを移動していないため、ファイルリストは元のまま

2. **連続アクセスによる表示異常**
   - 読み込みに失敗したディレクトリに再度Enterを押すと、同じディレクトリが追記される
   - 例：`/home/user/forbidden/forbidden/forbidden/...` のように延々と追記される

3. **ユーザーへのフィードバック不足**
   - なぜディレクトリに入れないのかが明確でない

## ビジネス要件

- ファイルマネージャーとして基本的な操作の信頼性を確保する
- ユーザーが操作結果を明確に理解できるようにする
- エラー発生時でも操作を継続できる状態を維持する

## 機能要件

### FR-1: ディレクトリ移動のアトミック性

- ディレクトリの読み込みが成功した場合のみ、パスを更新する
- 読み込みに失敗した場合は、パスを元のまま維持する
- ファイルリストとパス表示が常に整合している状態を保つ

### FR-2: エラーメッセージの表示

- ディレクトリ読み込みに失敗した場合、ステータスバーにエラーメッセージを表示する
- メッセージ形式：`{エラー種別}: {ディレクトリパス}`
  - 例：`Permission denied: /root/secret`
  - 例：`No such directory: /home/user/deleted`
- メッセージは5秒間表示後に自動的に消える

### FR-3: 対象エラーの範囲

以下のすべてのエラーケースで同様の動作を行う：
- 読み取り権限がない（Permission denied）
- ディレクトリが存在しない（No such file or directory）
- I/Oエラー（入出力エラー）
- その他のファイルシステムエラー

## 非機能要件

### NFR-1: パフォーマンス

- エラー検出と表示は即座に行われること（体感できる遅延なし）
- タイムアウト処理への影響がないこと

### NFR-2: 互換性

- 既存のキーバインディングに影響を与えない
- 既存のナビゲーション機能（`~`、`-`など）に影響を与えない

## ユースケース

### UC-1: 権限のないディレクトリに入ろうとする

**前提条件：**
- ユーザーが `/home/user` にいる
- `/root` ディレクトリが見えている

**操作：**
1. ユーザーがカーソルを `/root` に合わせる
2. Enter キーを押す

**期待される結果：**
- カレントディレクトリは `/home/user` のまま
- ファイルリストは `/home/user` の内容のまま
- ステータスバーに `Permission denied: /root` と表示される
- 5秒後にメッセージが消える

### UC-2: 存在しないディレクトリに移動しようとする

**前提条件：**
- シンボリックリンクのリンク先が削除されている

**操作：**
1. ユーザーがリンク切れのシンボリックリンクにカーソルを合わせる
2. Enter キーを押す

**期待される結果：**
- カレントディレクトリは元のまま
- ファイルリストは元の内容のまま
- ステータスバーに `No such directory: /path/to/target` と表示される

### UC-3: エラー後の通常操作

**前提条件：**
- UC-1 または UC-2 の後

**操作：**
1. 別のディレクトリにカーソルを移動
2. Enter キーを押す

**期待される結果：**
- 正常にディレクトリに入れる
- パスが正しく更新される
- エラーメッセージは消える（または次の操作で消える）

## UI/UX要件

### ステータスバーメッセージ

- 表示位置：画面下部のステータスバー
- 表示時間：5秒間
- 文字色：赤系またはエラーを示す色（実装依存）
- 次の操作があった場合は即座に消える

## 技術的制約

- Bubble Tea フレームワークの非同期メッセージング機構を使用
- 既存の `LoadDirectoryAsync()` の仕組みを活用

## 成功基準

1. 読み取り権限のないディレクトリに入ろうとしても、パス表示が変わらない
2. エラー時にステータスバーにメッセージが表示される
3. エラー後も正常なナビゲーション操作が可能
4. 既存のテストがすべて通る
5. 新規テストケースが追加される

## テストシナリオ

### TS-1: 権限エラーのテスト

- 読み取り権限のないディレクトリに移動を試みる
- パスが変更されないことを確認
- エラーメッセージが表示されることを確認

### TS-2: 連続操作のテスト

- 権限のないディレクトリへの移動を複数回試みる
- パス表示が延長されないことを確認

### TS-3: 正常操作との組み合わせテスト

- エラー発生後に正常なディレクトリに移動できることを確認

## 確認済み事項

| 項目 | 回答 |
|------|------|
| 警告の表示方法 | ステータスバー |
| 対象エラー範囲 | すべてのディレクトリ読み込みエラー |
| メッセージ表示時間 | 5秒 |
| メッセージ形式 | シンプル（例：`Permission denied: /path`） |

## 備考

- 現在のエラーダイアログ表示機能は別の用途で残す可能性がある
- シンボリックリンクの既存処理（リンク切れチェック）との整合性を保つ
