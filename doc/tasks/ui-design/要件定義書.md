# 機能要件定義書: UI設計（MVP）

## 1. 概要

duofm の初期バージョン（MVP: Minimum Viable Product）における基本的なユーザーインターフェースの設計と実装。

デュアルペイン（左右2つのペイン）を持つTUIファイルマネージャーとして、最小限の機能で動作することを目指す。

## 2. 目的

- デュアルペインファイルマネージャーとして最低限動作する画面を作成する
- 基本的なナビゲーション（ディレクトリ移動）を実装する
- 基本的なファイル操作（コピー、移動、削除）を実装する
- 将来的な機能拡張を見据えた設計とする

## 3. ユーザーストーリー

### MVP（初期バージョン）

- ユーザーとして、左右2つのペインでディレクトリを表示したい
- ユーザーとして、キーボードでディレクトリ間を移動したい
- ユーザーとして、ファイルをコピー・移動・削除したい
- ユーザーとして、誤操作を防ぐために削除時に確認ダイアログを表示してほしい
- ユーザーとして、キーバインド一覧を表示して操作方法を確認したい

### Phase 2（次の優先度）

- ユーザーとして、ファイルをエディタやビューアーで開きたい
- ユーザーとして、複数ファイルをマークして一括操作したい
- ユーザーとして、ファイルをソートして見やすく表示したい
- ユーザーとして、隠しファイルの表示/非表示を切り替えたい
- ユーザーとして、ファイルの詳細情報（サイズ、日時、パーミッション）を見たい

### Phase 3（将来的な拡張）

- ユーザーとして、ファイル名で検索・絞り込みをしたい
- ユーザーとして、高度なナビゲーション機能（ジャンプ、スクロール）を使いたい
- ユーザーとして、大きなファイルのコピー時に進捗を確認したい
- ユーザーとして、ファイルパスをクリップボードにコピーしたい
- ユーザーとして、前回開いていたディレクトリを記憶してほしい

## 4. 機能要件

### 4.1 画面表示（MVP）

#### 4.1.1 基本レイアウト

```
┌────────────────────────────────────────────────────────────────┐
│ duofm v0.1.0                                                    │ ← タイトルバー
├──────────────────────────────┬─────────────────────────────────┤
│ /home/user/Documents         │ /home/user                      │ ← パス表示
├──────────────────────────────┼─────────────────────────────────┤
│ ../                          │ ../                             │
│ Projects/                    │ Documents/                      │
│ README.md                    │ Downloads/                      │
│ notes.txt                    │ Pictures/                       │
│ image.png                    │ .bashrc                         │
│                               │                                 │
│                               │                                 │
│                               │                                 │
├──────────────────────────────┴─────────────────────────────────┤
│ 3/5                                        ?:help q:quit       │ ← ステータスバー
└────────────────────────────────────────────────────────────────┘
```

**構成要素:**
- **タイトルバー**: アプリケーション名とバージョン
- **パス表示**: 各ペインの現在のディレクトリパス（ホームディレクトリは `~` で表示）
- **デュアルペイン**: 左右2つのファイル/ディレクトリ一覧
- **ステータスバー**: 選択位置/総数、基本的なキーヒント

#### 4.1.2 ファイル/ディレクトリの表示

**MVP（最小限）:**
- ディレクトリ名の末尾に `/` を付ける
- 親ディレクトリは `../` で表示
- カーソル（選択中の項目）を視覚的に表示（ハイライトまたは `>` マーカー）

**デフォルトのソート:**
- ディレクトリを先に表示
- 名前順（昇順、アルファベット/50音順）

**Phase 2 で追加:**
- ファイルサイズ、更新日時の表示
- アイコン表示（📁 📄 🔗 など）
- パーミッション情報の表示

#### 4.1.3 起動時のディレクトリ

- **左ペイン**: カレントディレクトリ（duofm を起動したディレクトリ）
- **右ペイン**: ホームディレクトリ（`~`）

**Phase 3 で追加:**
- 右ペインは前回開いていたディレクトリを保持
- 前回のディレクトリが削除されている場合はホームディレクトリを表示

### 4.2 ナビゲーション（MVP）

#### 4.2.1 基本移動（hjkl）

| キー | 動作 |
|------|------|
| `j` | カーソルを下に移動 |
| `k` | カーソルを上に移動 |
| `h` | 左ペインに移動 / 親ディレクトリへ移動（左ペインの場合） |
| `l` | 右ペインに移動 / 親ディレクトリへ移動（右ペインの場合） |

**動作の詳細:**

**左ペインにフォーカスがある場合:**
- `h`: 左ペインを親ディレクトリに移動
- `l`: 右ペインにフォーカスを移動

**右ペインにフォーカスがある場合:**
- `h`: 左ペインにフォーカスを移動
- `l`: 右ペインを親ディレクトリに移動

**上下移動の制限:**
- リストの最上部より上には移動できない（ループなし）
- リストの最下部より下には移動できない（ループなし）

#### 4.2.2 ディレクトリに入る

| キー | 動作 |
|------|------|
| `Enter` | ディレクトリに入る（ディレクトリが選択されている場合） |

**MVP の制限:**
- ファイルで `Enter` を押しても何も起こらない（Phase 2 でファイルを開く機能を追加）

#### 4.2.3 終了

| キー | 動作 |
|------|------|
| `q` | アプリケーションを終了 |

**Phase 2 で追加する高度なナビゲーション:**
- `gg`: リストの先頭に移動
- `G`: リストの末尾に移動
- `Ctrl+D`: 半ページ下にスクロール
- `Ctrl+U`: 半ページ上にスクロール

### 4.3 ファイル操作（MVP）

#### 4.3.1 コピー

| キー | 動作 |
|------|------|
| `c` | 選択されたファイル/ディレクトリを隣のペインのディレクトリにコピー |

**動作の詳細:**
- 左ペインで `c` → 右ペインのディレクトリにコピー
- 右ペインで `c` → 左ペインのディレクトリにコピー
- コピー先に同名ファイルが存在する場合、上書きする（Phase 2 で確認ダイアログを追加）

**Phase 2 で追加:**
- コピー先に同名ファイルがある場合の確認ダイアログ
- 同じペイン内でのコピー（別名でコピー）
- 名前を指定するダイアログ

#### 4.3.2 移動

| キー | 動作 |
|------|------|
| `m` | 選択されたファイル/ディレクトリを隣のペインのディレクトリに移動 |

**動作の詳細:**
- 左ペインで `m` → 右ペインのディレクトリに移動
- 右ペインで `m` → 左ペインのディレクトリに移動
- 移動先に同名ファイルが存在する場合、上書きする（Phase 2 で確認ダイアログを追加）

**Phase 2 で追加:**
- 移動先に同名ファイルがある場合の確認ダイアログ
- 同じペイン内での移動（リネーム）
- 名前を指定するダイアログ

#### 4.3.3 削除

| キー | 動作 |
|------|------|
| `d` | 選択されたファイル/ディレクトリを削除（確認ダイアログを表示） |

**確認ダイアログ:**
```
┌───────────────────────────────┐
│ Delete file?                  │
│                               │
│ notes.txt                     │
│                               │
│ [y] Yes  [n] No               │
└───────────────────────────────┘
```

**動作:**
- `y` または `Enter`: 削除を実行
- `n` または `Esc`: キャンセル

**Phase 2 で追加:**
- マークされた複数ファイルの一括削除
- ディレクトリの再帰的削除の確認

### 4.4 ヘルプ画面（MVP）

#### 4.4.1 ヘルプ表示

| キー | 動作 |
|------|------|
| `?` | ヘルプ画面を表示（lazygit スタイルのキーバインド一覧） |

**ヘルプ画面のレイアウト（lazygit スタイル）:**
```
┌─────────────────────────────────────────────────────────────┐
│ Keybindings                                                  │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│ Navigation                                                   │
│   j/k      : move cursor down/up                            │
│   h/l      : move to left/right pane or parent directory    │
│   Enter    : enter directory                                │
│   q        : quit                                            │
│                                                              │
│ File Operations                                              │
│   c        : copy to opposite pane                          │
│   m        : move to opposite pane                          │
│   d        : delete (with confirmation)                     │
│                                                              │
│ Help                                                         │
│   ?        : show this help                                 │
│                                                              │
│                                                              │
│ Press Esc or ? to close                                     │
└─────────────────────────────────────────────────────────────┘
```

**動作:**
- ヘルプ画面はモーダルとして表示（背景のペインは操作不可）
- `Esc` または `?` で閉じる

### 4.5 エラーハンドリング（MVP）

#### 4.5.1 エラーメッセージの表示

ファイル操作でエラーが発生した場合、モーダルダイアログでメッセージを表示:

```
┌───────────────────────────────┐
│ Error                         │
│                               │
│ Permission denied             │
│                               │
│ Press Esc to close            │
└───────────────────────────────┘
```

**対象となるエラー:**
- パーミッションエラー（読み取り/書き込み不可）
- ファイルが見つからない
- ディスク容量不足
- その他のファイルシステムエラー

**動作:**
- `Esc` または `Enter` でダイアログを閉じる
- エラー後も操作を続行可能

**Phase 2 で追加:**
- エラーの詳細情報（スタックトレース、エラーコード）
- リトライ・スキップ・中断のオプション

#### 4.5.2 シンボリックリンクの扱い

**MVP:**
- シンボリックリンクはリンク先を辿る（透過的に扱う）
- リンク先が存在しない場合（broken link）は通常のファイルとして表示

**Phase 2 で追加:**
- シンボリックリンクのビジュアル表示（🔗 アイコン、または色分け）
- リンク先のパス表示

### 4.6 Phase 2 で追加する機能（参考）

以下の機能は MVP には含まれず、次のフェーズで実装する:

#### ファイルを開く
- `Enter`: ファイルを less で開く
- `e`: vim で開く
- `@`: コマンドを指定して開く
- `n`: 新規ファイルを vim で作成

#### マーク機能
- `Space`: ファイル/ディレクトリをマーク/アンマーク
- `V`: 全選択/全解除
- マークされたファイルの一括操作（コピー、移動、削除）

#### ソート機能
- `s`: ソート切り替え（名前/日時/サイズ）
- ペインごとに独立したソート状態

#### 表示切り替え
- `Ctrl+H`: 隠しファイル（`.` で始まるファイル）の表示/非表示
- `p`: パーミッション情報の表示/非表示

#### リネーム/コピーのダイアログ
- 同じペイン内での `m`: リネーム（名前入力ダイアログ）
- 同じペイン内での `c`: 別名でコピー（名前入力ダイアログ）
- 同名ファイルが存在する場合の警告表示

#### ステータスバーの拡張
- マークされたファイル数と合計サイズ
- 現在のソート状態
- より詳細なキーヒント

### 4.7 Phase 3 で追加する機能（参考）

さらに将来的に実装する機能:

#### 検索機能
- `/`: 正規表現でファイル名を検索・絞り込み
- 空文字で絞り込み解除

#### 高度なナビゲーション
- `gg`: リストの先頭に移動
- `G`: リストの末尾に移動
- `Ctrl+D`: 半ページ下にスクロール
- `Ctrl+U`: 半ページ上にスクロール

#### プログレスインジケーター
- 大きなファイルのコピー/移動時に進捗を表示
- `Esc` でキャンセル可能

#### パスのコピー
- `Ctrl+C`: 選択ファイルのフルパスをクリップボードにコピー

#### ディレクトリ同期
- `=`: 反対側のペインを現在のペインのディレクトリに移動

#### リフレッシュ
- `F5` または `Ctrl+R`: ディレクトリの内容を再読み込み

#### マーク操作拡張
- `v`: ビジュアルモード（範囲選択）
- `*`: パターンマッチでマーク

#### 前回のディレクトリを記憶
- 右ペインは前回開いていたディレクトリを保持
- 設定ファイル（`~/.config/duofm/state.json` など）に保存

## 5. 非機能要件

### 5.1 パフォーマンス

- ディレクトリの読み込みは1秒以内に完了すること（通常サイズのディレクトリ）
- キー入力に対する応答は即座に行われること（体感で遅延なし）

### 5.2 互換性

- Linux、macOS で動作すること
- 最小限のターミナルサイズ: 80x24（標準的なターミナルサイズ）

### 5.3 保守性

- 将来的な機能拡張を見据えた設計
- キーバインドは設定ファイルで変更可能にする準備（MVP ではハードコーディング）

## 6. 制約事項

### MVP の制約

- ファイルを開く機能は含まない（ディレクトリ移動のみ）
- マーク機能は含まない（単一ファイルの操作のみ）
- ソート切り替えは含まない（デフォルトのソートのみ）
- 検索機能は含まない
- 設定ファイルは含まない（キーバインドはハードコーディング）

### 技術的制約

- Go 1.21 以上を使用
- TUI ライブラリとして Bubble Tea を推奨

## 7. 成功基準

### MVP の成功基準

- [ ] デュアルペインでディレクトリを表示できる
- [ ] hjkl でナビゲーションできる
- [ ] Enter でディレクトリに入れる
- [ ] ファイルをコピー・移動・削除できる
- [ ] 削除時に確認ダイアログが表示される
- [ ] エラー発生時にメッセージが表示される
- [ ] ヘルプ画面でキーバインド一覧を確認できる
- [ ] 起動時に左ペインはカレントディレクトリ、右ペインはホームディレクトリが表示される

## 8. スケジュール（参考）

- **MVP（Phase 1）**: 基本的な画面表示とナビゲーション、ファイル操作
- **Phase 2**: ファイルを開く、マーク、ソート、表示切り替え、ダイアログ拡張
- **Phase 3**: 検索、高度なナビゲーション、プログレス表示、設定ファイル対応

## 9. 参考情報

### 参考にするファイルマネージャー

- **Midnight Commander (mc)**: 伝統的なデュアルペインファイルマネージャー
- **ranger**: Vim ライクなキーバインドを持つファイルマネージャー
- **nnn**: 軽量で高速なファイルマネージャー
- **lazygit**: ヘルプ画面のスタイル参考

### 技術スタック

- **言語**: Go 1.21+
- **TUI ライブラリ**: Bubble Tea（推奨）
- **ファイル操作**: 標準ライブラリ（os, filepath, io）

## 10. オープンクエスチョン

- [ ] MVP の実装完了後、ユーザーテストを実施して使いやすさを検証
- [ ] Phase 2 の優先順位を決定（どの機能から実装するか）
- [ ] パフォーマンス要件の詳細な定義（大きなディレクトリの扱い）
