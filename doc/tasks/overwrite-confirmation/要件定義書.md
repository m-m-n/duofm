# 要件定義書: 上書き確認ダイアログ

## 概要

ファイルのコピーまたは移動操作時に、相手ペインに同名のファイルが存在する場合、上書き確認ダイアログを表示する機能を実装する。

## 背景と目的

現在のduofmでは、コピー・移動操作時に同名ファイルが存在する場合、確認なしで上書きされる。これにより、意図しないデータ損失が発生する可能性がある。本機能により、ユーザーが明示的に上書きを承認するか、別名で保存するか、操作をキャンセルするかを選択できるようにする。

## 機能要件

### FR1: 上書き確認ダイアログの表示

- FR1.1: コピー操作（`c`キー）時、宛先に同名ファイルが存在する場合にダイアログを表示
- FR1.2: 移動操作（`m`キー）時、宛先に同名ファイルが存在する場合にダイアログを表示
- FR1.3: コンテキストメニュー（`@`キー）からのコピー・移動時も同様に確認
- FR1.4: 同名ファイルが存在しない場合は従来通り即座に操作を実行

### FR2: ダイアログの選択肢

以下の3つの選択肢を提供する：

1. **上書き（Overwrite）**: 既存ファイルを上書きして操作を実行
2. **キャンセル（Cancel）**: 操作を中止
3. **別名で保存（Rename）**: 新しいファイル名を入力して操作を実行

### FR3: キー操作

- FR3.1: 数字キー（`1`, `2`, `3`）で直接選択
- FR3.2: `j`/`k`または矢印キー（↑/↓）でカーソル移動
- FR3.3: `Enter`で現在選択中の項目を実行
- FR3.4: `Esc`でキャンセル（選択肢2と同じ動作）

### FR4: 別名入力

- FR4.1: 「別名で保存」選択時、入力ダイアログを表示
- FR4.2: 入力されたファイル名が宛先に既に存在する場合、エラーメッセージを表示
- FR4.3: 既存ファイル名の場合は確定不可（Enterキーで確定できない）
- FR4.4: 空文字の場合も確定不可

### FR5: ディレクトリの扱い

- FR5.1: コピー・移動先に同名のディレクトリが存在する場合、エラーダイアログを表示
- FR5.2: マージ操作は行わない（安全性とシンプルさのため）
- FR5.3: エラーメッセージ例: 「ディレクトリ "src" は既に存在します」

### FR6: シンボリックリンクの扱い

- FR6.1: シンボリックリンクはファイルと同様に上書き確認ダイアログを表示
- FR6.2: 宛先がシンボリックリンクの場合も確認対象とする
- FR6.3: 壊れたシンボリックリンクのコピーはエラーとして処理（既存動作）

## 非機能要件

### NFR1: ユーザビリティ

- NFR1.1: ダイアログにはソースと宛先のファイル情報を表示（サイズ、更新日時）
- NFR1.2: 選択中の項目は視覚的にハイライト
- NFR1.3: 各選択肢の横に対応する数字を表示

### NFR2: 一貫性

- NFR2.1: 既存のダイアログ（削除確認、コンテキストメニュー）と同じUIパターンを使用
- NFR2.2: キーバインドは既存の操作と整合性を保つ

### NFR3: パフォーマンス

- NFR3.1: ファイル存在チェックは操作実行時に行う
- NFR3.2: ダイアログ表示は即座に行われる（100ms以内）

## 対象外（スコープ外）

- 複数ファイルの一括操作時の「すべてにYes」「すべてにNo」オプション
- ディレクトリのマージ機能
- 上書き確認のスキップオプション（設定による無効化）

## UI設計

### 上書き確認ダイアログ

```
┌─ File already exists ────────────────┐
│                                       │
│  "example.txt" already exists in      │
│  /home/user/destination/              │
│                                       │
│  Source: 1,234 bytes  2024-01-15      │
│  Dest:   2,567 bytes  2024-01-10      │
│                                       │
│  1. Overwrite                         │
│  2. Cancel                            │
│  3. Rename                            │
│                                       │
│  1-3/j/k:select Enter:confirm         │
└───────────────────────────────────────┘
```

### ディレクトリ存在時のエラーダイアログ

```
┌─ Cannot copy directory ──────────────┐
│                                       │
│  Directory "src" already exists in    │
│  /home/user/destination/              │
│                                       │
│  [Enter] OK                           │
└───────────────────────────────────────┘
```

### 別名入力ダイアログ（既存ファイル名入力時）

```
┌─ Rename ─────────────────────────────┐
│                                       │
│  New name: example_copy.txt           │
│                                       │
│  [Error] File already exists          │
│                                       │
│  Enter:confirm  Esc:cancel            │
└───────────────────────────────────────┘
```

## 受け入れ条件

1. ファイルコピー時、同名ファイルがあれば確認ダイアログが表示される
2. ファイル移動時、同名ファイルがあれば確認ダイアログが表示される
3. 「上書き」選択で既存ファイルが上書きされる
4. 「キャンセル」選択で操作が中止される
5. 「別名」選択で入力ダイアログが表示され、新しい名前で保存できる
6. 別名入力時、既存ファイル名はエラー表示され確定できない
7. ディレクトリコピー・移動時、同名ディレクトリがあればエラーダイアログが表示される
8. シンボリックリンクもファイルと同様に確認ダイアログが表示される
