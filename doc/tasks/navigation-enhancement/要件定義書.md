# 要件定義書: ナビゲーション強化機能

## 1. 概要

duofmのナビゲーション機能を強化し、より効率的なディレクトリ移動と隠しファイル管理を実現する。

### 1.1 対象機能

1. **隠しファイル表示トグル** (Ctrl+H)
2. **ホームディレクトリへの移動** (~)
3. **直前のディレクトリへの移動** (-)

### 1.2 背景

シェル環境で一般的に使われるナビゲーション操作をTUIファイルマネージャーでも利用可能にし、ユーザーの既存の操作習慣を活かす。

## 2. 機能要件

### 2.1 隠しファイル表示トグル

#### 動作仕様
- **キーバインド**: `Ctrl+H`
- **対象**: アクティブなペインのみ
- **デフォルト**: 非表示（隠しファイルを表示しない）

#### 詳細
| 項目 | 仕様 |
|------|------|
| トグル対象 | `.`で始まるファイル・ディレクトリ |
| 設定の独立性 | 左右のペインで別々に設定可能 |
| 状態の永続化 | セッション中のみ保持（再起動でリセット） |
| カーソル位置 | トグル後も可能な限り同じファイルにカーソルを維持 |

#### 表示フィードバック
- ステータスバーまたはペインヘッダーに現在の状態を表示
- 例: 隠しファイル表示中は `[H]` などのインジケーター

### 2.2 ホームディレクトリへの移動

#### 動作仕様
- **キーバインド**: `~`（チルダ）
- **対象**: アクティブなペイン
- **移動先**: 現在のユーザーのホームディレクトリ

#### 詳細
| 項目 | 仕様 |
|------|------|
| ホームディレクトリ取得 | `os.UserHomeDir()` を使用 |
| エラー時の動作 | ホームディレクトリ取得失敗時はエラーダイアログ表示 |
| 履歴更新 | 移動前のディレクトリを直前ディレクトリとして記録 |

### 2.3 直前のディレクトリへの移動

#### 動作仕様
- **キーバインド**: `-`（ハイフン）
- **対象**: アクティブなペイン
- **動作**: シェルの `cd -` と同様のトグル移動

#### 詳細
| 項目 | 仕様 |
|------|------|
| 履歴保持数 | 1件のみ（直前のディレクトリのみ記録） |
| 履歴の独立性 | 左右のペインで別々に管理 |
| 初期状態 | 起動直後は直前ディレクトリなし（-を押しても何も起きない） |
| トグル動作 | A→B移動後、-でB→A、再度-でA→B |

#### 履歴更新のタイミング
以下の操作時に直前ディレクトリを更新する:
- Enter でディレクトリに移動
- h/← または l/→ で親ディレクトリに移動
- ~ でホームディレクトリに移動
- - で直前のディレクトリに移動

## 3. 非機能要件

### 3.1 パフォーマンス要件
| 項目 | 目標値 |
|------|--------|
| キー入力レスポンス | 50ms以内 |
| 隠しファイルトグル時のリスト更新 | 100ms以内 |
| ディレクトリ移動 | 既存と同等 |

### 3.2 ユーザビリティ要件
- 既存のキーバインドとの競合がないこと
- 操作が直感的であること（シェルの操作に準拠）
- 状態が視覚的に分かること

## 4. UI/UX要件

### 4.1 キーボード操作

| キー | 操作 | 対象ペイン |
|------|------|-----------|
| `Ctrl+H` | 隠しファイル表示トグル | アクティブペイン |
| `~` | ホームディレクトリへ移動 | アクティブペイン |
| `-` | 直前のディレクトリへ移動 | アクティブペイン |

### 4.2 視覚的フィードバック

#### 隠しファイル表示インジケーター
- 位置: ペインのヘッダー部分（パス表示の隣）
- 表示: 隠しファイル表示ON時のみ `[H]` または類似のマーク
- スタイル: 目立つが邪魔にならない色（グレーまたは控えめな色）

### 4.3 エラー表示

| エラー状況 | 表示方法 |
|-----------|----------|
| ホームディレクトリ取得失敗 | エラーダイアログ |
| 直前ディレクトリが存在しない | 何もしない（サイレント） |
| 直前ディレクトリへのアクセス不可 | エラーダイアログ |

## 5. 技術的要件

### 5.1 状態管理

#### Pane構造体への追加フィールド
```
- showHidden: bool        # 隠しファイル表示フラグ
- previousPath: string    # 直前のディレクトリパス
```

### 5.2 既存コードへの影響

| コンポーネント | 影響 |
|--------------|------|
| keys.go | 新規キー定義追加 |
| pane.go | 隠しファイルフィルタリング、履歴管理追加 |
| model.go | キーハンドラー追加 |
| styles.go | インジケーター用スタイル追加（必要に応じて） |

### 5.3 依存関係
- 既存の `fs` パッケージの `HomeDirectory()` 関数を使用
- 外部ライブラリの追加は不要

## 6. テスト要件

### 6.1 単体テスト

#### 隠しファイルトグル
- [ ] トグルONで隠しファイルがリストに含まれる
- [ ] トグルOFFで隠しファイルがリストから除外される
- [ ] 各ペインで独立して動作する
- [ ] トグル後にカーソル位置が適切に維持される

#### ホームディレクトリ移動
- [ ] 正しくホームディレクトリに移動する
- [ ] 移動前のパスが直前ディレクトリとして記録される

#### 直前ディレクトリ移動
- [ ] 直前ディレクトリがある場合に正しく移動する
- [ ] 直前ディレクトリがない場合は何も起きない
- [ ] トグル動作が正しく機能する（A→B→A→B...）
- [ ] 各ペインで独立した履歴を持つ

### 6.2 統合テスト

- [ ] Ctrl+H、~、- キーが正しく認識される
- [ ] 他のキーバインドと競合しない
- [ ] ペイン切り替え後も各ペインの設定が維持される

## 7. 成功基準

- [ ] 全てのキーバインドが正しく動作する
- [ ] 隠しファイルの表示/非表示が正しく切り替わる
- [ ] ホームディレクトリへの移動が正しく動作する
- [ ] 直前ディレクトリへのトグル移動が正しく動作する
- [ ] 各ペインで独立した設定・履歴が維持される
- [ ] 既存の機能に影響を与えない
- [ ] 全てのテストがパスする

## 8. 制約事項

- スタック形式の履歴管理は本機能のスコープ外（将来の別機能として検討）
- 設定ファイルへの永続化は本機能のスコープ外
- 複数の直前ディレクトリ履歴の保持は本機能のスコープ外
