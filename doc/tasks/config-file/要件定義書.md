# 要件定義書: 設定ファイル機能（キーバインド設定）

## 概要

duofmに設定ファイル機能を追加し、ユーザーがキーバインドをカスタマイズできるようにする。TOML形式の設定ファイルを`~/.config/duofm/config.toml`に配置し、アプリケーション起動時に読み込む。

## 目的

- ユーザーが好みのキーバインドでduofmを操作できるようにする
- XDG Base Directory仕様に準拠した設定ファイル配置
- 設定ファイルがない場合は自動生成し、すぐに使用可能にする

## ドメインルール

- 設定ファイルは`~/.config/duofm/config.toml`に配置する
- `XDG_CONFIG_HOME`が設定されている場合は`$XDG_CONFIG_HOME/duofm/config.toml`を使用する
- 設定ファイルが存在しない場合、初回起動時にデフォルト設定ファイルを自動生成する
- 無効な設定がある場合は警告を表示しデフォルト値で起動する
- 同一キーが複数アクションに割り当てられた場合、警告を表示し後勝ちで適用する

## 機能要件

### FR-1: 設定ファイルの読み込み

**概要**: アプリケーション起動時にTOML形式の設定ファイルを読み込む

**動作**:
- 起動時に`~/.config/duofm/config.toml`を読み込む
- `XDG_CONFIG_HOME`環境変数が設定されている場合はそれを優先
- ファイルが存在しない場合はFR-2に従い自動生成

### FR-2: 設定ファイルの自動生成

**概要**: 設定ファイルが存在しない場合、デフォルト値でファイルを自動生成する

**動作**:
- 初回起動時に`~/.config/duofm/`ディレクトリを作成
- デフォルトのキーバインド設定を含むconfig.tomlを生成
- 生成されたファイルには全アクションのデフォルト値をコメント付きで記載

### FR-3: キーバインドの設定

**概要**: 全キーバインドをカスタマイズ可能にする

**設定形式**（アルファベットは大文字、記号はそのまま）:
```toml
[keybindings]
# ナビゲーション
move_down = ["J", "Down"]
move_up = ["K", "Up"]
move_left = ["H", "Left"]
move_right = ["L", "Right"]
enter = ["Enter"]

# ファイル操作
copy = ["C"]
move = ["M"]
delete = ["D"]
rename = ["R"]
new_file = ["N"]
new_directory = ["Shift+N"]
mark = ["Space"]

# 表示
toggle_info = ["I"]
toggle_hidden = ["Ctrl+H"]
sort = ["S"]
help = ["?"]

# ナビゲーション拡張
home = ["~"]
prev_dir = ["-"]
refresh = ["F5", "Ctrl+R"]
sync_pane = ["="]

# 検索
search = ["/"]
regex_search = ["Ctrl+F"]

# 外部アプリケーション
view = ["V"]
edit = ["E"]
shell_command = ["!"]
context_menu = ["@"]

# アプリケーション
quit = ["Q"]
escape = ["Esc"]
```

**動作**:
- アクション名に対して1つ以上のキーを配列で指定
- 1アクションに複数キーを割り当て可能（例: `refresh = ["F5", "Ctrl+R"]`）
- 未定義のアクションはデフォルト値を使用

### FR-4: エラーハンドリング

**概要**: 設定ファイルのパースエラーや無効な設定への対応

**動作**:
- パースエラー: 警告を表示しデフォルト設定で起動
- 無効なキー名: 警告を表示し該当アクションはデフォルト値を使用
- 無効なアクション名: 警告を表示し無視
- 重複キー割り当て: 警告を表示し後勝ちで適用

**警告表示**:
- 起動時にステータスバーに警告メッセージを表示
- 例: `Warning: config parse error, using defaults`
- 例: `Warning: duplicate key "J" assigned to move_down and custom_action`

### FR-5: 修飾キーのサポート

**概要**: Ctrl、Alt、Shiftなどの修飾キーを含むキーバインドをサポート

**キー表記の原則**: 結果の文字で書く（キーボードレイアウト非依存）

**対応形式**:
- アルファベット: `"J"`, `"N"`（大文字）
- 記号: `"?"`, `"@"`, `"!"`, `"~"`（結果の文字をそのまま）
- 特殊キー: `"Enter"`, `"Esc"`, `"Space"`, `"Tab"`（PascalCase）
- 矢印キー: `"Up"`, `"Down"`, `"Left"`, `"Right"`
- ファンクションキー: `"F5"`, `"F1"`
- Ctrl修飾: `"Ctrl+H"`, `"Ctrl+R"`, `"Ctrl+="`
- Shift修飾: `"Shift+N"`（Shiftキーを押しながら大文字N）
- Alt修飾: `"Alt+X"`, `"Alt+Enter"`
- 複合修飾: `"Ctrl+Shift+N"`, `"Alt+Shift+X"`

### FR-6: キー無効化

**概要**: 特定のキーバインドを無効化可能にする

**動作**:
- 空の配列を指定することでアクションを無効化: `help = []`
- 無効化されたアクションはそのキーを押しても何も起こらない

### FR-7: ヘルプダイアログのキー表記統一

**概要**: ヘルプダイアログ（`?`キー）のキー表記を設定ファイルと統一する

**動作**:
- ヘルプダイアログ内のキー表記はPascalCase形式を使用
- 設定ファイルの表記形式と完全に一致させる
- 例: `j/k` → `J/K`、`ctrl+h` → `Ctrl+H`

## 非機能要件

### NFR-1: パフォーマンス

- 設定ファイルの読み込みは起動時に1回のみ実行
- 読み込み処理は100ms以内に完了すること

### NFR-2: 設定ファイルのサイズ

- 生成されるデフォルト設定ファイルは100行以内
- 人間が読みやすいようにコメントとセクション分けを行う

### NFR-3: 後方互換性

- 設定ファイルがない場合でも従来通りの動作を保証
- 既存のハードコードされたデフォルトキーバインドは維持

## ユーザーストーリー

1. ユーザーとして、vim風キーバインドではなくEmacs風（Ctrl+n/Ctrl+p）でナビゲーションしたい
2. ユーザーとして、よく使う操作に覚えやすいキーを割り当てたい
3. ユーザーとして、使わない機能のキーを無効化して誤操作を防ぎたい
4. ユーザーとして、設定例を見ながらカスタマイズしたいので、自動生成されたファイルにコメントがほしい

## 受け入れ条件

- [ ] アプリ起動時に`~/.config/duofm/config.toml`を読み込む
- [ ] `XDG_CONFIG_HOME`環境変数に対応している
- [ ] 設定ファイルがない場合、デフォルト設定ファイルが自動生成される
- [ ] 生成された設定ファイルにはコメント付きで全アクションが記載されている
- [ ] TOML形式で`[keybindings]`セクションにキーバインドを定義できる
- [ ] 1アクションに複数キーを配列で指定できる
- [ ] 空の配列でアクションを無効化できる
- [ ] Ctrl/Shiftなどの修飾キーを含むキーバインドを設定できる
- [ ] パースエラー時は警告表示しデフォルトで起動する
- [ ] 重複キー割り当て時は警告表示し後勝ちで適用する
- [ ] 設定ファイルがなくても従来通りの動作をする
- [ ] 既存機能（コピー、移動、削除、マーク等）に影響がない
