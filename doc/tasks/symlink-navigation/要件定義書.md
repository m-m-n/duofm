# シンボリックリンクナビゲーション仕様の明確化

## 概要

シンボリックリンクに対するナビゲーション操作（Enter、コンテキストメニュー）の挙動を明確化し、既存の仕様書との不整合を修正する。

## 背景

### 現状の問題

1. **仕様書の記述が曖昧**: 「論理パス」「物理パス」の定義が不明確
2. **Open link target の挙動が不正確**: 仕様書では「リンク先の親ディレクトリを開く」と記載されているが、期待される挙動は「リンク先そのものに移動」

### 用語の定義

| 用語 | 定義 | 例 (`/bin -> /usr/bin`) |
|------|------|-------------------------|
| **論理パス** | シンボリックリンクのパスを維持したナビゲーション | `/bin` に入り、`..` で `/` に戻る |
| **物理パス** | リンク先の実体パスへのナビゲーション | `/usr/bin` に移動、`..` で `/usr` に戻る |

## ビジネス要件

### 目的

- ユーザーがシンボリックリンクの論理的な構造と物理的な構造の両方を直感的にナビゲートできるようにする
- Total Commanderや他のファイルマネージャーと同様の操作感を提供する

### ユースケース

1. **開発者**: シンボリックリンクで構成されたプロジェクト構造を論理的にナビゲート
2. **システム管理者**: `/bin`、`/sbin` 等のシステムディレクトリを効率的に操作
3. **一般ユーザー**: リンク先の実体を確認したい場合に物理パスへ移動

## 機能要件

### FR1: Enter キーによる論理パスナビゲーション

シンボリックリンクディレクトリで Enter を押した場合：

- **FR1.1**: シンボリックリンクのパスをカレントディレクトリとして記憶する
  - 例: `/bin -> /usr/bin` で Enter → カレントディレクトリは `/bin`
- **FR1.2**: `..` で親ディレクトリに移動する際、論理的な親に移動する
  - 例: `/bin` から `..` → `/` に移動
- **FR1.3**: リンク先ディレクトリの内容を表示する
  - 例: `/bin` に入ると `/usr/bin` の内容が表示される

```
操作フロー:
/bin -> /usr/bin

1. /bin を選択して Enter
2. カレントディレクトリ: /bin （表示される内容は /usr/bin のファイル一覧）
3. .. を選択して Enter
4. カレントディレクトリ: / （/bin の論理的な親）
```

### FR2: コンテキストメニュー「Enter as directory (logical)」

- **FR2.1**: Enter キーと同一の動作を行う
- **FR2.2**: シンボリックリンクディレクトリの場合のみメニューに表示する

### FR3: コンテキストメニュー「Open link target (physical)」

シンボリックリンクで「Open link target」を選択した場合：

- **FR3.1**: リンク先の実体パスに直接移動する
  - 例: `/bin -> /usr/bin` で実行 → カレントディレクトリは `/usr/bin`
- **FR3.2**: 移動後は通常のディレクトリとして扱う
  - 例: `/usr/bin` から `..` → `/usr` に移動
- **FR3.3**: リンク切れの場合は無効化（グレーアウト）する
- **FR3.4**: シンボリックリンクの場合のみメニューに表示する

```
操作フロー:
/bin -> /usr/bin

1. /bin を選択して @ でコンテキストメニュー
2. 「Open link target (physical)」を選択
3. カレントディレクトリ: /usr/bin （リンク先そのもの）
4. .. を選択して Enter
5. カレントディレクトリ: /usr （物理的な親）
```

### FR4: チェーンされたシンボリックリンク

複数段階のシンボリックリンク（例: `link1 -> link2 -> actual_dir`）の場合：

- **FR4.1**: 表示されるリンク先は1段階目のみ（`link2`）
- **FR4.2**: Enter（論理パス）は現在のリンクのパスを維持
- **FR4.3**: Open link target（物理パス）は1段階だけ辿る（`link2` に移動）
- **FR4.4**: 最終的な実体への到達は、ユーザーが繰り返し操作することで行う

### FR5: リンク先の表示形式

- **FR5.1**: リンク先は絶対パスで表示する
  - 例: `link -> ../foo` は `link -> /absolute/path/to/foo` と表示
- **FR5.2**: `ls -l` の出力が相対パスでも、duofmでは絶対パスに変換する

### FR6: ファイルへのシンボリックリンク（将来実装）

- **FR6.1**: Open link target はリンク先のファイルを開く動作（エディタ等）
- **FR6.2**: 本仕様では実装対象外（現状維持）

## 非機能要件

### NFR1: パフォーマンス

- シンボリックリンクの解決は即座に行う（キャッシュ不要）
- 深いチェーン（10段階以上）でも遅延なく動作する

### NFR2: エラーハンドリング

- リンク切れの場合、エラーメッセージを表示せず視覚的に区別する（赤色表示）
- 権限エラーの場合、適切なエラーメッセージを表示する

## UI/UX 要件

### リンク先の色分け

| 状態 | 色 |
|------|-----|
| 有効なシンボリックリンク | シアン |
| リンク切れ | 赤 |

### コンテキストメニュー表示

シンボリックリンクディレクトリ選択時：
```
┌─ Context Menu ───────────────────────┐
│  1. Copy to other pane               │
│  2. Move to other pane               │
│  3. Delete                           │
│  4. Enter as directory (logical)     │
│  5. Open link target (physical)      │
└──────────────────────────────────────┘
```

## 確認済み事項

本仕様は以下の対話で確認済み：

1. **論理パスの動作**: Enter で `/bin` に入り、`..` で `/` に戻る ✓
2. **物理パスの動作**: Open link target で `/usr/bin` に直接移動 ✓
3. **チェーンされたリンク**: 1段階だけ辿る ✓
4. **リンク先の表示**: 絶対パスで表示（現状維持） ✓
5. **ファイルへのリンク**: 将来実装（現状維持） ✓

## 影響範囲

### 修正が必要なファイル

1. `doc/tasks/context-menu/SPEC.md` - FR3の記述修正
2. `doc/tasks/context-menu/要件定義書.md` - FR3の記述修正
3. `internal/ui/context_menu_dialog.go` - Open link target の実装修正

### 既存機能への影響

- Enter キーの動作は変更なし（現状が正しい動作）
- Open link target のみ修正が必要

## テストシナリオ

### TS1: 論理パスナビゲーション

```
前提条件: /tmp/test-link -> /usr/share/doc
操作:
  1. /tmp に移動
  2. test-link を選択して Enter
  3. カレントディレクトリが /tmp/test-link であることを確認
  4. .. を選択して Enter
  5. カレントディレクトリが /tmp であることを確認
期待結果: 論理的な親ディレクトリに戻る
```

### TS2: 物理パスナビゲーション

```
前提条件: /tmp/test-link -> /usr/share/doc
操作:
  1. /tmp に移動
  2. test-link を選択して @ でコンテキストメニュー
  3. 「Open link target (physical)」を選択
  4. カレントディレクトリが /usr/share/doc であることを確認
  5. .. を選択して Enter
  6. カレントディレクトリが /usr/share であることを確認
期待結果: リンク先に直接移動し、物理的な親に戻る
```

### TS3: リンク切れの処理

```
前提条件: /tmp/broken-link -> /nonexistent
操作:
  1. /tmp に移動
  2. broken-link を選択して @ でコンテキストメニュー
期待結果: 「Open link target (physical)」が無効化されている
```

### TS4: チェーンされたシンボリックリンク

```
前提条件:
  /tmp/link1 -> /tmp/link2
  /tmp/link2 -> /usr/share
操作:
  1. /tmp に移動
  2. link1 を選択して @ でコンテキストメニュー
  3. 「Open link target (physical)」を選択
期待結果: /tmp/link2 に移動（最終的な /usr/share ではない）
```

## 成功基準

1. Enter キーで論理パスナビゲーションが正しく動作する
2. Open link target でリンク先そのものに移動する
3. 既存のテストが引き続きパスする
4. 仕様書の記述が実装と一致している
