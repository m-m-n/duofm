# カラーテーマ機能 要件定義書

## 概要

duofmにカラーテーマ機能を追加し、設定ファイル（config.toml）からすべてのUI要素の色をカスタマイズできるようにする。

## 背景と目的

### 背景
- 現在のduofmはハードコードされた色を使用している
- ユーザーの好みや端末の色設定に合わせたカスタマイズができない
- 視認性の問題（明るい/暗い背景での見づらさ）を解決できない

### 目的
- ユーザーがすべてのUI要素の色を自由にカスタマイズできるようにする
- 既存の設定ファイル（config.toml）の構造を拡張して対応する
- シンプルで直感的な色設定インターフェースを提供する

## 対象ユーザー

- duofmをカスタマイズして使用したいユーザー
- ターミナルテーマに合わせた配色を求めるユーザー
- 視認性の問題を抱えるユーザー

## 機能要件

### FR-1: 設定ファイルでの色定義

設定ファイル（config.toml）の `[colors]` セクションで色を定義できる。

- FR-1.1: `[colors]` セクションでUI要素ごとに色を指定できる
- FR-1.2: 色の指定がない要素はデフォルト値を使用する
- FR-1.3: 設定ファイルの変更はアプリケーション再起動で反映される

### FR-2: サポートする色形式

ANSI 256色コードのみをサポートする。

- FR-2.1: ANSI 256色コード（0-255の整数、例: 39, 240）
- FR-2.2: 無効な色指定（範囲外、非数値）の場合は警告を表示しデフォルト値を使用

### FR-3: カスタマイズ可能なUI要素

すべてのUI要素の色をカスタマイズできる。

#### ペイン関連
- FR-3.1: カーソル行（前景・背景）- アクティブ/非アクティブペイン
- FR-3.2: マークされた行（前景・背景）- アクティブ/非アクティブペイン
- FR-3.3: カーソル+マーク行（前景・背景）- アクティブ/非アクティブペイン
- FR-3.4: パス表示 - アクティブ/非アクティブペイン
- FR-3.5: ヘッダー（カラム名）- アクティブ/非アクティブペイン
- FR-3.6: ボーダー（区切り線）

#### ファイルタイプ関連
- FR-3.7: ディレクトリ
- FR-3.8: シンボリックリンク
- FR-3.9: 実行可能ファイル
- FR-3.10: 通常ファイル

#### ダイアログ関連
- FR-3.11: ダイアログタイトル
- FR-3.12: ダイアログボーダー
- FR-3.13: ダイアログ選択項目（前景・背景）
- FR-3.14: ダイアログフッター（ヒント）

#### 入力関連
- FR-3.15: 入力フィールド（前景・背景）
- FR-3.16: ミニバッファ（前景・背景）
- FR-3.17: エラーメッセージ

#### ステータス関連
- FR-3.18: ステータスバー（前景・背景）
- FR-3.19: 警告メッセージ

### FR-4: デフォルトテーマ

設定がない場合のデフォルトテーマを提供する。

- FR-4.1: 現在のハードコードされた色をデフォルト値として使用
- FR-4.2: デフォルト設定ファイルの自動生成時に `[colors]` セクションを含める

### FR-5: ヘルプダイアログの拡張

既存のヘルプダイアログを拡張し、カラーパレット参照を統合する。

#### スクロール機能
- FR-5.1: ヘルプダイアログにスクロール機能を追加（j/kで1行ずつ）
- FR-5.2: Spaceで1画面下へ、Shift+Spaceで1画面上へスクロール
- FR-5.3: 現在のスクロール位置を視覚的に表示（ページ番号）

#### カラーパレット参照セクション
- FR-5.4: 既存のキーバインドセクションの後にカラーパレットセクションを追加
- FR-5.5: 0-15は「端末設定依存」と説明を表示
- FR-5.6: 16-231は6x6x6カラーキューブとして#rrggbb形式で表示
- FR-5.7: 232-255はグレースケールとして#rrggbb形式で表示
- FR-5.8: 各色番号の横に実際の色でサンプルを表示（背景色として）

### FR-6: エラーハンドリング

色設定のエラーを適切に処理する。

- FR-6.1: 無効な色形式の場合、警告を表示しデフォルト値を使用
- FR-6.2: 不明なカラーキーの場合、警告を表示し無視
- FR-6.3: パースエラーがあっても他の設定は正常に読み込む

## 非機能要件

### NFR-1: パフォーマンス
- NFR-1.1: 色設定の読み込みは起動時に1回のみ
- NFR-1.2: 起動時間への影響は10ms以下

### NFR-2: 互換性
- NFR-2.1: `[colors]` セクションがなくても正常に動作（後方互換性）
- NFR-2.2: 既存の設定ファイルとの互換性を維持

### NFR-3: 保守性
- NFR-3.1: 色定義は一箇所で管理（styles.go または新規ファイル）
- NFR-3.2: 新しいUI要素追加時に容易に色設定を追加できる構造

## 設定ファイル形式

```toml
# ~/.config/duofm/config.toml
# 色は ANSI 256色コード（0-255）で指定

[colors]
# ペイン - カーソル
cursor_fg = 15                      # 白
cursor_bg = 39                      # アクティブペイン（青）
cursor_bg_inactive = 240            # 非アクティブペイン（グレー）

# ペイン - マーク
mark_fg = 0                         # 黒（アクティブペイン）
mark_fg_inactive = 15               # 白（非アクティブペイン）
mark_bg = 136                       # アクティブペイン（黄土色）
mark_bg_inactive = 94               # 非アクティブペイン（暗い黄）

# ペイン - カーソル+マーク
cursor_mark_fg = 15                 # 白
cursor_mark_bg = 30                 # アクティブペイン（シアン）
cursor_mark_bg_inactive = 23        # 非アクティブペイン（暗いシアン）

# ペイン - パス表示
path_fg = 39                        # アクティブペイン（青）
path_fg_inactive = 240              # 非アクティブペイン（グレー）

# ペイン - ヘッダー
header_fg = 245                     # アクティブペイン
header_fg_inactive = 240            # 非アクティブペイン

# ペイン - その他
border_fg = 240
dimmed_bg = 236
dimmed_fg = 243

# ファイルタイプ
directory_fg = 39                   # 青
symlink_fg = 14                     # シアン
executable_fg = 9                   # 赤

# ダイアログ
dialog_title_fg = 39
dialog_border_fg = 39
dialog_selected_fg = 0              # 黒
dialog_selected_bg = 39             # 青
dialog_footer_fg = 240

# 入力
input_fg = 15                       # 白
input_bg = 236
input_border_fg = 240

# ミニバッファ
minibuffer_fg = 15                  # 白
minibuffer_bg = 236

# エラー・警告
error_fg = 196                      # 赤
error_border_fg = 196
warning_fg = 240

# ステータスバー
status_fg = 15                      # 白
status_bg = 240
```

## テストシナリオ

### ユニットテスト
- [ ] 256色コード（0-255）が正しくパースされる
- [ ] 範囲外の色コード（256以上、負数）でエラーが返される
- [ ] 非数値の色コードでエラーが返される
- [ ] デフォルト設定が正しく適用される
- [ ] 部分的な色設定でデフォルトとマージされる

### 統合テスト
- [ ] `[colors]` セクションがない場合デフォルトで動作
- [ ] 部分的な色設定が正しく適用される
- [ ] 無効な色指定で警告が表示される
- [ ] 全色指定で正しく描画される

### E2Eテスト
- [ ] カスタム設定でアプリケーションが正しく起動する
- [ ] カーソル色が設定通りに表示される
- [ ] ダイアログ色が設定通りに表示される
- [ ] ファイルタイプ色が設定通りに表示される
- [ ] ヘルプダイアログでスクロールが動作する
- [ ] ヘルプダイアログにカラーパレットセクションが表示される

## 成功基準

- [ ] config.toml の `[colors]` セクションで全UI要素の色を定義できる
- [ ] ANSI 256色コード（0-255）がサポートされている
- [ ] 設定がない場合は現在の配色（デフォルト）が使用される
- [ ] 無効な色指定で警告が表示され、デフォルト値が使用される
- [ ] 既存の設定ファイルとの後方互換性が維持される
- [ ] ヘルプダイアログがスクロール可能になっている
- [ ] ヘルプダイアログにカラーパレット参照が含まれている
- [ ] 全ユニットテストがパスする
- [ ] 全統合テストがパスする

## 制約事項

- 設定変更はアプリケーション再起動で反映（リアルタイム変更は対象外）
- プリセットテーマ（Gruvbox等）は対象外
- HEX形式（#rrggbb）は対象外（256色パレット番号のみ）
- 色名（"red", "blue"等）による指定は対象外
- フォントスタイル（太字、斜体等）の設定は対象外

## 依存関係

- 既存の設定ファイル機能（internal/config）
- lipglossライブラリの色サポート
- 既存のUI描画コード（internal/ui）

## 参考資料

- 既存の設定ファイル仕様: doc/tasks/config-file/SPEC.md
- lipgloss色ドキュメント: github.com/charmbracelet/lipgloss
