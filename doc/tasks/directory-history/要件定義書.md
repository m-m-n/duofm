# ディレクトリ履歴機能 - 要件定義書

## 1. 概要

duofmに、ブラウザライクなディレクトリ履歴機能を追加する。ユーザーが訪問したディレクトリの履歴を各ペイン独立に保持し、`Alt+←`/`Alt+→`または`[`/`]`キーで前後に移動できるようにする。

### 1.1 背景

現在の実装では`-`キーで直前のディレクトリとトグルできるが、これは最後の2つのディレクトリ間の移動に限定される。より柔軟なディレクトリナビゲーションのため、訪問したディレクトリの完全な履歴を保持し、ブラウザの「戻る」「進む」のような操作を可能にする。

### 1.2 目的

- ディレクトリ間の移動を効率化
- 深い階層を探索した後、簡単に元の場所に戻れるようにする
- TUIファイルマネージャーとしての使い勝手を向上

## 2. ドメインルール

### 2.1 履歴の基本原則

- **DR1.1**: 各ペイン（左右）は独立した履歴スタックを持つ
- **DR1.2**: 履歴の最大保持数は100件とする
- **DR1.3**: 100件を超えた場合、最も古い履歴から削除される（FIFO）
- **DR1.4**: 履歴はセッション限定（アプリケーション終了で消える）
- **DR1.5**: すべてのディレクトリ遷移を履歴に記録する（親ディレクトリへの移動を含む）

### 2.2 履歴の状態管理

- **DR2.1**: 履歴には「現在位置」の概念がある（ブラウザの履歴と同じ）
- **DR2.2**: 新しいディレクトリに移動すると、現在位置以降の履歴は削除され、新しい履歴が追加される
- **DR2.3**: 「戻る」操作では現在位置を履歴スタック内で後方に移動するだけで、履歴は削除しない
- **DR2.4**: 「進む」操作では現在位置を履歴スタック内で前方に移動するだけで、履歴は削除しない

**例:**
```
初期状態: [A, B, C, D*, E]  (* = 現在位置)
戻る操作: [A, B, C*, D, E]
戻る操作: [A, B*, C, D, E]
新規移動: [A, B, F*]  (C, D, Eは削除される)
```

### 2.3 履歴記録の条件

以下のすべてのディレクトリ遷移を履歴に記録する：

- **DR3.1**: `Enter`キーでサブディレクトリに入る
- **DR3.2**: `h`/`←`キーまたは`..`で親ディレクトリに移動
- **DR3.3**: `~`キーでホームディレクトリに移動
- **DR3.4**: `-`キーで直前のディレクトリに移動（トグル操作）
- **DR3.5**: ブックマークからのディレクトリ移動
- **DR3.6**: `=`キーでペイン同期
- **DR3.7**: シンボリックリンクを辿ってディレクトリに移動
- **DR3.8**: その他すべてのディレクトリ変更操作

**例外（履歴に記録しない）:**
- 履歴ナビゲーション自体（`Alt+←`/`Alt+→`/`[`/`]`）

### 2.4 削除・リネームされたディレクトリ

- **DR4.1**: 履歴に含まれるディレクトリが削除またはリネームされた場合でも、履歴からは削除しない
- **DR4.2**: 存在しないディレクトリへの履歴移動を試みた場合、エラーメッセージを表示し、現在のディレクトリに留まる
- **DR4.3**: エラーメッセージは「Directory not found: /path/to/dir」形式とする

### 2.5 既存機能との共存

- **DR5.1**: `-`キーの既存機能（直前ディレクトリとのトグル）は**維持**する
- **DR5.2**: `-`キーでのトグル移動も履歴に記録される（DR3.4）
- **DR5.3**: 履歴機能と`-`キー機能は独立して動作する

## 3. 機能要件

### 3.1 履歴の保持

- **FR1.1**: 各`Pane`構造体に履歴スタックを保持するフィールドを追加する
- **FR1.2**: 履歴スタックは以下の情報を持つ：
  - 履歴リスト（最大100件）
  - 現在位置インデックス
- **FR1.3**: ディレクトリ遷移時、新しいパスを履歴に追加する
- **FR1.4**: 履歴が100件を超えた場合、最も古いエントリを削除する
- **FR1.5**: `previousPath`フィールドは**維持**し、`-`キーの実装に使用する

### 3.2 履歴のナビゲーション

- **FR2.1**: `Alt+←`キーで履歴を1つ戻る
- **FR2.2**: `Alt+→`キーで履歴を1つ進む
- **FR2.3**: `[`キーで履歴を1つ戻る（`Alt+←`と同じ動作）
- **FR2.4**: `]`キーで履歴を1つ進む（`Alt+→`と同じ動作）
- **FR2.5**: 戻れる履歴がない場合、操作は無視される（エラー表示なし）
- **FR2.6**: 進める履歴がない場合、操作は無視される（エラー表示なし）

### 3.3 既存機能との関係

- **FR3.1**: `-`キーの既存動作（直前ディレクトリとのトグル）は**維持**する
- **FR3.2**: `previousPath`フィールドは**維持**し、引き続き`-`キーの実装に使用する
- **FR3.3**: `-`キーでの移動も履歴に記録される

### 3.4 エラーハンドリング

- **FR4.1**: 履歴移動先のディレクトリが存在しない場合：
  - ステータスバーにエラーメッセージを5秒間表示
  - 現在のディレクトリに留まる
  - 履歴の現在位置は変更しない（再度同じ操作を試みることができる）
- **FR4.2**: 履歴移動先のディレクトリに読み込み権限がない場合：
  - 既存のディレクトリエラーハンドリングと同じ動作
  - ステータスバーにエラーメッセージを表示

## 4. 非機能要件

### 4.1 パフォーマンス

- **NFR1.1**: 履歴への追加操作はO(1)で完了する
- **NFR1.2**: 履歴のナビゲーション操作はO(1)で完了する
- **NFR1.3**: 履歴の保持によるメモリ使用量は無視できる範囲（各パス平均100バイトとして、100件×2ペイン = 約20KB）

### 4.2 信頼性

- **NFR2.1**: 履歴機能の追加により、既存のディレクトリナビゲーション機能に影響を与えない
- **NFR2.2**: 履歴が破損した場合（通常は発生しない）でも、アプリケーションはクラッシュしない

### 4.3 保守性

- **NFR3.1**: 履歴管理ロジックは`Pane`構造体内にカプセル化する
- **NFR3.2**: 履歴の内部実装を変更しても、外部インターフェースに影響しない

## 5. インターフェース仕様

### 5.1 データ構造

#### 5.1.1 ディレクトリ履歴

```
DirectoryHistory {
    paths: []string      // 履歴パスのリスト（最大100件）
    currentIndex: int    // 現在位置のインデックス（-1 = 履歴なし）
    maxSize: int         // 最大保持数（100）
}
```

**不変条件:**
- `0 <= currentIndex < len(paths)` または `currentIndex == -1`（履歴が空の場合）
- `len(paths) <= maxSize`

#### 5.1.2 Pane構造体への追加

```
type Pane struct {
    // ... 既存フィールド ...
    previousPath string          // 直前のディレクトリパス（-キー用、維持）
    history      DirectoryHistory // ディレクトリ履歴（新規追加）
}
```

### 5.2 操作仕様

#### 5.2.1 履歴への追加

```
関数: AddToHistory(path string)
前提条件: path は有効なディレクトリパス
事後条件:
  - 履歴の現在位置以降のエントリは削除される
  - 新しいパスが履歴の末尾に追加される
  - currentIndexは末尾を指す
  - 履歴が100件を超える場合、先頭のエントリが削除される
  - 連続して同じパスは追加しない（重複排除）
```

**動作例:**
```
初期状態: paths=[A, B, C], currentIndex=2
AddToHistory(D) → paths=[A, B, C, D], currentIndex=3

途中の状態: paths=[A, B, C, D], currentIndex=1 (Bを指している)
AddToHistory(E) → paths=[A, B, E], currentIndex=2
```

#### 5.2.2 履歴を戻る

```
関数: NavigateBack() (path string, ok bool)
前提条件: なし
戻り値:
  - path: 移動先のパス
  - ok: true=移動可能, false=戻れる履歴なし
事後条件:
  - okがtrueの場合、currentIndexは1つ減る
  - okがfalseの場合、状態は変更されない
```

#### 5.2.3 履歴を進む

```
関数: NavigateForward() (path string, ok bool)
前提条件: なし
戻り値:
  - path: 移動先のパス
  - ok: true=移動可能, false=進める履歴なし
事後条件:
  - okがtrueの場合、currentIndexは1つ増える
  - okがfalseの場合、状態は変更されない
```

#### 5.2.4 状態確認

```
関数: CanGoBack() bool
戻り値: 戻れる履歴があるか

関数: CanGoForward() bool
戻り値: 進める履歴があるか
```

### 5.3 キーバインド定義

#### 5.3.1 新規アクション

```
ActionHistoryBack    // 履歴を戻る
ActionHistoryForward // 履歴を進む
```

#### 5.3.2 キーマッピング

```
"history_back":    ["Alt+Left", "["]
"history_forward": ["Alt+Right", "]"]
"prev_dir":        ["-"]  // 既存のまま維持
```

## 6. UI/UX要件

### 6.1 キーボード操作

| キー | 操作 | 補足 |
|------|------|------|
| `Alt+←` | 履歴を戻る | Webブラウザと同じ |
| `Alt+→` | 履歴を進む | Webブラウザと同じ |
| `[` | 履歴を戻る | ホームポジションから操作可能 |
| `]` | 履歴を進む | ホームポジションから操作可能 |
| `-` | 直前ディレクトリとトグル | 既存機能（維持） |

### 6.2 フィードバック

| 操作 | フィードバック | 表示時間 |
|------|----------------|----------|
| 履歴移動成功 | なし（ディレクトリが変わるだけ） | - |
| 履歴移動失敗（存在しない） | "Directory not found: /path/to/dir" | 5秒 |
| 履歴移動失敗（権限なし） | "Permission denied: /path/to/dir" | 5秒 |
| 戻れる履歴なし | なし（操作を無視） | - |
| 進める履歴なし | なし（操作を無視） | - |

### 6.3 ステータス表示

履歴の状態をステータスバーに表示する必要は**ない**（ユーザー要求による）。

## 7. テストシナリオ

### 7.1 基本動作

- [ ] シナリオ1: 新しいディレクトリに移動すると履歴に追加される
- [ ] シナリオ2: `Alt+←`または`[`で履歴を戻れる
- [ ] シナリオ3: `Alt+→`または`]`で履歴を進める
- [ ] シナリオ4: 履歴がない状態で戻る/進む操作をしても何も起きない
- [ ] シナリオ5: 左右のペインで独立した履歴を持つ

### 7.2 履歴の状態管理

- [ ] シナリオ6: A→B→Cと移動後、2回戻ってからDに移動すると、履歴は[A, B, D]になる
- [ ] シナリオ7: 履歴が100件を超えると、古いものから削除される
- [ ] シナリオ8: 連続して同じディレクトリに移動しても、履歴には1回だけ記録される

### 7.3 各種ナビゲーション方法

- [ ] シナリオ9: `Enter`でサブディレクトリに入ると履歴に記録される
- [ ] シナリオ10: `h`/`←`で親ディレクトリに移動すると履歴に記録される
- [ ] シナリオ11: `~`でホームディレクトリに移動すると履歴に記録される
- [ ] シナリオ12: `-`で直前ディレクトリに移動すると履歴に記録される
- [ ] シナリオ13: ブックマークから移動すると履歴に記録される
- [ ] シナリオ14: `=`でペイン同期すると履歴に記録される
- [ ] シナリオ15: シンボリックリンクを辿ると履歴に記録される

### 7.4 履歴ナビゲーション自体

- [ ] シナリオ16: `Alt+←`で戻った後、新しいディレクトリに移動すると、進む履歴は消える
- [ ] シナリオ17: 履歴ナビゲーション（`Alt+←`/`Alt+→`/`[`/`]`）は履歴に記録されない

### 7.5 既存機能との統合

- [ ] シナリオ18: `-`キーは引き続き正常に動作する（直前ディレクトリとトグル）
- [ ] シナリオ19: `-`キーでの移動も履歴に記録される
- [ ] シナリオ20: A→B→Cと移動後、`-`でB、`[`でAに戻れる

### 7.6 エラーハンドリング

- [ ] シナリオ21: 履歴に含まれるディレクトリが削除された場合、移動を試みるとエラーメッセージが表示される
- [ ] シナリオ22: エラーが発生しても、履歴の現在位置は変わらない（再試行可能）
- [ ] シナリオ23: 履歴に含まれるディレクトリに権限がない場合、適切なエラーメッセージが表示される

## 8. 成功基準

- [ ] すべてのテストシナリオが成功する
- [ ] 既存のディレクトリナビゲーション機能（`-`キーを含む）が影響を受けない
- [ ] 履歴の最大サイズ（100件）が正しく機能する
- [ ] 左右のペインで独立した履歴が動作する
- [ ] キーバインド（`Alt+←`/`Alt+→`/`[`/`]`）が正しく動作する
- [ ] エラーハンドリングが適切に機能する
- [ ] パフォーマンスへの影響が無視できる範囲である

## 9. 制約事項

### 9.1 技術的制約

- Bubble Tea（TUIフレームワーク）の制約により、`Alt+キー`の組み合わせが端末エミュレータによって異なる可能性がある
- 一部の端末では`Alt+←`/`Alt+→`が正しく認識されない場合がある（そのために`[`/`]`も提供）

### 9.2 ビジネス制約

- セッション限定の履歴（永続化しない）
- 履歴の最大サイズは100件固定（設定で変更不可）

## 10. オープンクエスチョン

なし（すべての要件が明確化されている）

## 11. 参考情報

### 11.1 類似実装

- Webブラウザの履歴機能（Chrome, Firefox等）
- Midnight Commander（`Alt+O`で履歴ダイアログ）
- ranger（親子ディレクトリ間の移動履歴）

### 11.2 既存コード

- `internal/ui/pane.go`: `previousPath`フィールドの実装（維持）
- `internal/ui/keys.go`: キー定義
- `internal/ui/actions.go`: アクション定義
- `internal/config/defaults.go`: デフォルトキーバインド
