# 要件定義書: Unicode表示幅の修正

## 背景

現在のduofmでは、日本語などのマルチバイト文字を含むファイル/ディレクトリ名を表示する際に、表示が崩れる問題が発生している。

### 問題の原因

Go言語の`len()`関数は文字列の**バイト長**を返すが、ターミナル上での表示では**文字幅**（全角=2、半角=1）で計算する必要がある。

**例**: "テスト.txt"
- `len("テスト.txt")` = **15バイト** (UTF-8エンコーディング)
- 実際の表示幅 = **10** (全角3文字×2 + 半角4文字×1)

この差異により以下の問題が発生:
1. ファイル名の切り詰めが不正（バイト単位でスライスするため不正なUTF-8になる可能性）
2. パディング計算が狂い、列の整列が崩れる

## 目的

日本語を含む全てのUnicode文字のファイル/ディレクトリ名が正しく表示されるようにする。

## 機能要件

### FR-1: ファイル名表示の文字幅対応

`DisplayNameWithLimit()`関数を修正し、正しい表示幅で文字列を切り詰める。

- 全角文字は幅2、半角文字は幅1として計算する
- 文字列の切り詰めはルーン（Unicode code point）単位で行う
- 切り詰め後の文字列は常に有効なUTF-8であること

### FR-2: ファイル一覧のパディング計算修正

`formatBasicEntry()`および`formatDetailEntry()`のパディング計算を表示幅ベースに修正する。

- `len()`ではなく`runewidth.StringWidth()`を使用
- ファイル名、サイズ、日時の各列が正しく整列すること

### FR-3: ヘッダー表示のレイアウト修正

`renderHeaderLine2()`のレイアウト計算を表示幅ベースに修正する。

- マーク情報とディスク空き容量の表示位置が正しいこと

### FR-4: ステータスバーのメッセージ切り詰め修正

`renderStatusBar()`のメッセージ切り詰めを表示幅ベースに修正する。

- 日本語を含むメッセージが正しく切り詰められること
- 切り詰め後も有効なUTF-8であること

## 非機能要件

### NFR-1: パフォーマンス

- 文字幅計算による表示速度の低下が体感できないこと
- 大量のファイル（1000件以上）を含むディレクトリでも問題なく動作すること

### NFR-2: 互換性

- 既存の英数字のみのファイル名の表示は変更しない
- ANSIエスケープシーケンス（色付け）との互換性を維持

## 対象ファイルと修正箇所

| ファイル | 関数 | 修正内容 |
|---------|------|---------|
| `internal/fs/types.go` | `DisplayNameWithLimit()` | ルーン単位での切り詰め |
| `internal/ui/pane.go` | `formatBasicEntry()` | パディング計算を幅ベースに |
| `internal/ui/pane.go` | `formatDetailEntry()` | パディング計算を幅ベースに |
| `internal/ui/pane.go` | `renderHeaderLine2()` | レイアウト計算を幅ベースに |
| `internal/ui/model.go` | `renderStatusBar()` | メッセージ切り詰めを幅ベースに |

## 使用ライブラリ

`github.com/mattn/go-runewidth`（既に依存関係に存在）

主な関数:
- `runewidth.StringWidth(s string) int` - 文字列の表示幅を計算
- `runewidth.Truncate(s string, w int, tail string) string` - 表示幅で切り詰め

## 受け入れ条件

- [ ] 日本語ファイル名が正しく表示される
- [ ] 日本語ファイル名を含むファイル一覧で列が整列している
- [ ] 長い日本語ファイル名が省略記号(...)付きで正しく切り詰められる
- [ ] 既存のテストが全てパスする
- [ ] 新規テストケースが追加されている
