# 要件定義書: ディレクトリブックマーク機能

## 1. 概要

duofmにディレクトリブックマーク機能を追加する。ユーザーは頻繁にアクセスするディレクトリをブックマークとして登録し、素早くジャンプできるようになる。

## 2. 目的

- 頻繁にアクセスするディレクトリへの移動を効率化する
- ユーザーが独自のエイリアス名でディレクトリを管理できるようにする
- 設定ファイルに保存することで、セッション間でブックマークを永続化する

## 3. ユーザーストーリー

- ユーザーとして、よく使うディレクトリをブックマークに登録したい
- ユーザーとして、ブックマーク一覧から素早くディレクトリにジャンプしたい
- ユーザーとして、ブックマークにわかりやすい名前（エイリアス）を付けたい
- ユーザーとして、不要になったブックマークを削除したい

## 4. 機能要件

### FR-1: ブックマークの追加（Shift+B）

- FR-1.1: `Shift+B`キーで現在のアクティブペインのディレクトリをブックマークに追加する
- FR-1.2: エイリアス入力ダイアログを表示する
- FR-1.3: デフォルトのエイリアスはディレクトリのbasename（例：`/path/to/projects` → `projects`）
- FR-1.4: `Enter`で確定、`Esc`でキャンセル
- FR-1.5: 同じパスが既に登録されている場合は「登録済み」と表示し、追加しない
- FR-1.6: 新しいブックマークはリストの先頭に追加される

### FR-2: ブックマーク管理画面（B）

- FR-2.1: `B`キーでブックマーク管理ダイアログを表示する
- FR-2.2: ブックマークは2行形式で表示する（1行目：エイリアス、2行目：パス）
- FR-2.3: パスが長い場合は折り返して全部表示する
- FR-2.4: `j`/`k`キーで上下にカーソル移動できる
- FR-2.5: `Enter`で選択したブックマークのディレクトリにジャンプする
- FR-2.6: `D`キーで選択したブックマークを削除する
- FR-2.7: `E`キーで選択したブックマークのエイリアスを編集する
- FR-2.8: `Esc`キーでダイアログを閉じる

### FR-3: ブックマークへのジャンプ

- FR-3.1: ブックマーク選択後、アクティブペインが対象ディレクトリに移動する
- FR-3.2: 存在しないパスへのジャンプは無効化する
- FR-3.3: ジャンプ後、ブックマーク管理ダイアログは自動的に閉じる

### FR-4: 存在しないパスの表示

- FR-4.1: 存在しないパスのブックマークには警告マーク（絵文字）を表示する
- FR-4.2: 警告マークのついたブックマークはジャンプ不可とする
- FR-4.3: 削除・編集は可能とする

### FR-5: 設定ファイルへの保存

- FR-5.1: ブックマークは `[bookmarks]` セクションに保存する
- FR-5.2: TOML配列形式（`[[bookmarks]]`）で保存する
- FR-5.3: 各ブックマークは `name`（エイリアス）と `path`（パス）を持つ
- FR-5.4: ブックマークの追加・削除・編集時に設定ファイルを更新する

### FR-6: ブックマークの編集

- FR-6.1: 編集ダイアログでエイリアス名を変更できる
- FR-6.2: 現在のエイリアスが入力欄に表示される
- FR-6.3: `Enter`で確定、`Esc`でキャンセル

### FR-7: ブックマークの削除

- FR-7.1: `D`キーで選択中のブックマークを削除する
- FR-7.2: 確認ダイアログなしで即座に削除する（軽量な操作のため）

## 5. 非機能要件

### 5.1 パフォーマンス要件

- NFR-1.1: ブックマーク管理ダイアログの表示は100ms以内
- NFR-1.2: ブックマークへのジャンプは200ms以内
- NFR-1.3: 設定ファイルへの保存は100ms以内

### 5.2 データ制約

- NFR-2.1: ブックマーク数の上限は設けない（実用上は数十件程度を想定）
- NFR-2.2: エイリアス名の長さに制限は設けない

## 6. UI/UX要件

### 6.1 TUI画面設計

#### ブックマーク管理ダイアログ

```
┌─ Bookmarks ─────────────────────────┐
│ ▶ Projects                          │
│   /path/to/projects                 │
│                                     │
│   Downloads                         │
│   /path/to/Downloads                │
│                                     │
│ ⚠ OldBackup                         │
│   /mnt/external/backup              │
│   (path not found)                  │
├─────────────────────────────────────┤
│ Enter:Jump  D:Delete  E:Edit  Esc   │
└─────────────────────────────────────┘
```

#### エイリアス入力ダイアログ

```
┌─ Add Bookmark ──────────────────────┐
│ Alias: [projects          ]         │
│                                     │
│ Path: /path/to/projects             │
│                                     │
│           [Enter:OK] [Esc:Cancel]   │
└─────────────────────────────────────┘
```

### 6.2 キーボード操作

| キー | 操作 | 補足 |
|------|------|------|
| `B` | ブックマーク管理画面を開く | 通常モードで使用 |
| `Shift+B` | 現在のディレクトリをブックマーク追加 | 通常モードで使用 |
| `j`/`k` | ブックマーク選択を上下移動 | 管理画面内 |
| `Enter` | 選択したブックマークにジャンプ | 管理画面内 |
| `D` | 選択したブックマークを削除 | 管理画面内 |
| `E` | 選択したブックマークを編集 | 管理画面内 |
| `Esc` | ダイアログを閉じる | 管理画面内 |

### 6.3 フィードバック

| 操作 | フィードバック | 表示場所 |
|------|----------------|----------|
| ブックマーク追加成功 | 「Bookmarked: {alias}」 | ステータスバー |
| 既に登録済み | 「Already bookmarked」 | ステータスバー |
| ブックマーク削除 | 「Removed: {alias}」 | ステータスバー |
| 存在しないパスへのジャンプ試行 | 操作を無効化（何も起きない） | - |

## 7. インターフェース仕様

### 7.1 設定ファイル形式

```toml
# ブックマーク（新しいものが先頭）
[[bookmarks]]
name = "Projects"
path = "/path/to/projects"

[[bookmarks]]
name = "Downloads"
path = "/path/to/Downloads"

[[bookmarks]]
name = "Config"
path = "/path/to/.config"
```

### 7.2 エラー条件

| 条件 | 動作 |
|------|------|
| 設定ファイルが存在しない | 空のブックマークリストで開始 |
| ブックマークセクションがない | 空のブックマークリストで開始 |
| 不正なブックマークエントリ | 警告を表示し、そのエントリをスキップ |
| 設定ファイル書き込みエラー | エラーメッセージをステータスバーに表示 |

## 8. テストシナリオ

### ユニットテスト

- [ ] ブックマークの追加が正しく動作する
- [ ] ブックマークの削除が正しく動作する
- [ ] ブックマークの編集が正しく動作する
- [ ] 重複パスの検出が正しく動作する
- [ ] 存在しないパスの検出が正しく動作する
- [ ] 設定ファイルからのロードが正しく動作する
- [ ] 設定ファイルへの保存が正しく動作する

### E2Eテスト

- [ ] `Shift+B`でブックマーク追加ダイアログが表示される
- [ ] デフォルトエイリアスがディレクトリ名になっている
- [ ] `B`でブックマーク管理ダイアログが表示される
- [ ] `j`/`k`でブックマーク選択が移動する
- [ ] `Enter`で選択したブックマークにジャンプする
- [ ] `D`でブックマークが削除される
- [ ] `E`で編集ダイアログが表示される
- [ ] 存在しないパスに警告マークが表示される
- [ ] 存在しないパスへのジャンプが無効化される
- [ ] 設定ファイルにブックマークが保存される

## 9. 成功基準

- [ ] `Shift+B`で現在のディレクトリをブックマークに追加できる
- [ ] `B`でブックマーク管理画面を開ける
- [ ] ブックマーク一覧からディレクトリにジャンプできる
- [ ] ブックマークの編集・削除ができる
- [ ] 存在しないパスに警告が表示される
- [ ] ブックマークが設定ファイルに永続化される
- [ ] 全てのユニットテストが通る
- [ ] 全てのE2Eテストが通る

## 10. 依存関係

- `internal/config` パッケージ（設定ファイル読み書き）
- 既存のダイアログコンポーネント（テキスト入力、リスト選択）
- 既存のキーバインディング機構

## 11. 制約事項

- ブックマークの並び替えは設定ファイルの手動編集で行う
- パスの編集は対応しない（エイリアスのみ編集可能）
- ブックマークのインポート/エクスポート機能は対応しない
