# 要件定義書: ファイル/ディレクトリの新規作成とリネーム機能

## 概要

duofmに新規ファイル作成、新規ディレクトリ作成、およびリネーム機能を追加します。ユーザーはキーボードショートカットを使用して、これらの操作を直感的に実行できます。

## 背景と目的

ファイルマネージャーの基本機能として、ファイル/ディレクトリの作成とリネームは必須です。現在のduofmはコピー、移動、削除機能を提供していますが、新規作成とリネーム機能が欠けています。この機能を追加することで、ユーザーはduofm内で完結したファイル管理が可能になります。

## ユーザーストーリー

1. **新規ファイル作成**
   - ユーザーとして、`n`キーを押してファイル名を入力し、新規ファイルを作成したい
   - 空のファイルを素早く作成できることで、その後エディタで編集する流れがスムーズになる

2. **新規ディレクトリ作成**
   - ユーザーとして、`Shift+n`キーを押してディレクトリ名を入力し、新規ディレクトリを作成したい
   - プロジェクトの整理やファイル分類のために、新しいディレクトリを簡単に作成したい

3. **リネーム**
   - ユーザーとして、`r`キーを押してファイル名を入力し、選択中のファイル/ディレクトリをリネームしたい
   - タイポの修正やファイル名の整理を、外部ツールを使わずに行いたい

## 機能要件

### キーボードショートカット

| キー | 機能 | 対応するコマンド |
|------|------|-----------------|
| `n` | 新規ファイル作成 | ファイルが存在しないときの `touch` 相当 |
| `Shift+n` (大文字N) | 新規ディレクトリ作成 | ディレクトリが存在しないときの `mkdir` 相当 |
| `r` | リネーム | 同一ディレクトリ内での `mv` 相当 |

### UI設計

#### ダイアログ仕様

- **表示タイプ**: ペインローカル表示 (DialogDisplayPane)
  - アクティブペインのみdimmed表示
  - 非アクティブペインは通常表示のまま(ファイルリスト確認可能)
  - アクティブペイン中央にダイアログをオーバーレイ表示

- **ダイアログ構成**:
  ```
  ┌─────────────────────────────┐
  │ New file:                   │
  │ ┌─────────────────────────┐ │
  │ │ [入力欄]_               │ │
  │ └─────────────────────────┘ │
  │                             │
  │ Enter: Create  Esc: Cancel  │
  └─────────────────────────────┘
  ```

- **プロンプトメッセージ**:
  - 新規ファイル作成: `New file:`
  - 新規ディレクトリ作成: `New directory:`
  - リネーム: `Rename to:`

- **入力欄仕様**:
  - 1行テキスト入力
  - 初期値:
    - 新規作成: 空欄
    - リネーム: 空欄 (現在のファイル名は表示しない)
  - カーソル表示あり
  - 基本的なテキスト編集機能 (文字入力、Backspace、Delete、カーソル移動)

#### 操作方法

| キー | 動作 |
|------|------|
| `Enter` | 入力を確定して作成/リネームを実行 |
| `Esc` | キャンセルして元の状態に戻る |
| 文字キー | 入力欄に文字を追加 |
| `Backspace` | カーソル前の文字を削除 |
| `Delete` | カーソル位置の文字を削除 |
| `←` / `→` | カーソル移動 |
| `Ctrl+A` | カーソルを先頭に移動 |
| `Ctrl+E` | カーソルを末尾に移動 |
| `Ctrl+U` | カーソルより前を全削除 |
| `Ctrl+K` | カーソルより後を全削除 |

### 動作仕様

#### 新規ファイル作成 (nキー)

1. ユーザーが`n`キーを押す
2. 「New file:」というプロンプトのダイアログが表示される
3. ユーザーがファイル名を入力
4. `Enter`キーで確定
5. アクティブペインの現在のディレクトリに空のファイルを作成
6. 両ペインを再読み込み
7. 作成されたファイルにカーソルを移動
   - **例外**: 隠しファイル表示OFFでドットファイルを作成した場合、カーソルは元の位置に留まる

#### 新規ディレクトリ作成 (Shift+nキー)

1. ユーザーが`Shift+n`キーを押す
2. 「New directory:」というプロンプトのダイアログが表示される
3. ユーザーがディレクトリ名を入力
4. `Enter`キーで確定
5. アクティブペインの現在のディレクトリに新しいディレクトリを作成
6. 両ペインを再読み込み
7. 作成されたディレクトリにカーソルを移動
   - **例外**: 隠しファイル表示OFFでドットディレクトリを作成した場合、カーソルは元の位置に留まる

#### リネーム (rキー)

1. ユーザーが`r`キーを押す
2. 選択中のエントリをチェック:
   - 親ディレクトリ(..)の場合: 何もしない(無視)
   - 通常のファイル/ディレクトリの場合: 次へ
3. 「Rename to:」というプロンプトのダイアログが表示される
4. ユーザーが新しい名前を入力 (入力欄は空欄から開始)
5. `Enter`キーで確定
6. 同一ディレクトリ内でリネームを実行
7. 両ペインを再読み込み
8. リネームされたアイテムにカーソルを移動
   - **例外**: 隠しファイル表示OFFでドットファイルにリネームした場合、次のファイルにカーソル移動
     - 最後のファイルだった場合は一つ前のファイルに移動

### エラーハンドリング

すべてのエラーはステータスバーに表示し、5秒後に自動的にクリアします。

| エラーケース | ステータスバー表示内容 | 動作 |
|------------|---------------------|------|
| 空文字列で確定 | `File name cannot be empty` | ダイアログを閉じず、入力を継続可能 |
| 既存ファイル/ディレクトリと同名 | `File already exists: [ファイル名]` | ダイアログを閉じる、作成/リネームしない |
| パス区切り文字を含む (`/`) | `Invalid file name: path separator not allowed` | ダイアログを閉じる、作成/リネームしない |
| パーミッションエラー | `Permission denied: [エラー詳細]` | ダイアログを閉じる、作成/リネームしない |
| その他のファイルシステムエラー | `Failed to create/rename: [エラー詳細]` | ダイアログを閉じる、作成/リネームしない |

### 隠しファイルの扱い

#### 新規作成時

- ドット(`.`)で始まるファイル/ディレクトリ名の作成に制限はありません
- 隠しファイル表示がOFFの状態でドットファイルを作成した場合:
  - ファイル/ディレクトリは正常に作成される
  - 作成後のリストには表示されない (ユーザーが`Ctrl+H`で表示切替するまで見えない)
  - カーソルは元の位置に留まる

#### リネーム時

- ドット(`.`)で始まる名前へのリネームに制限はありません
- 通常ファイルをドットファイルにリネームした場合 (隠しファイル表示OFF):
  - リネームは正常に実行される
  - リネーム後のリストには表示されない
  - カーソルは次のファイルに移動 (最後のファイルの場合は一つ前に移動)

### カーソル位置の制御

#### 新規作成後

| 条件 | カーソル位置 |
|------|------------|
| 通常ファイル/ディレクトリを作成 | 作成されたアイテムに移動 |
| 隠しファイル表示ONでドットファイルを作成 | 作成されたアイテムに移動 |
| 隠しファイル表示OFFでドットファイルを作成 | 元の位置に留まる |

#### リネーム後

| 条件 | カーソル位置 |
|------|------------|
| 通常のリネーム | リネームされたアイテムに移動 (ソート順変更にも追従) |
| ドットファイルにリネーム (隠しファイル表示OFF) | 次のファイルに移動 (最後なら一つ前) |
| ドットファイルからリネーム (隠しファイル表示OFF) | リネームされたアイテムに移動 |

### ペインの再読み込み

- 新規作成/リネーム成功後は**両ペイン**を再読み込みします
- 理由: 左右のペインが同じディレクトリを表示している場合に、両方に変更を反映するため

## 非機能要件

### パフォーマンス

- ダイアログの表示は即座に行われること (< 100ms)
- ファイル/ディレクトリ作成/リネームは通常のファイルシステム速度で実行されること

### ユーザビリティ

- 既存のダイアログ (ConfirmDialog, ErrorDialog等) と一貫性のあるデザイン
- 既存の検索機能のミニバッファとは異なる、ダイアログベースのUI
- キーボードのみで完結する操作

### 信頼性

- ファイルシステムエラーを適切にハンドリングし、アプリケーションがクラッシュしない
- 無効な入力を受け付けず、適切なエラーメッセージを表示

## 成功基準

- [ ] `n`キーで新規ファイル作成ダイアログが開く
- [ ] `Shift+n`キーで新規ディレクトリ作成ダイアログが開く
- [ ] `r`キーでリネームダイアログが開く
- [ ] 各ダイアログで正しいプロンプトメッセージが表示される
- [ ] Enter確定、Escキャンセルが動作する
- [ ] 空文字列での確定がエラーになる
- [ ] 既存ファイル/ディレクトリと同名の場合にエラーメッセージが表示される
- [ ] パス区切り文字を含む名前が拒否される
- [ ] パーミッションエラーが適切に処理される
- [ ] 作成/リネーム後に正しくカーソルが移動する
- [ ] 隠しファイル表示OFFでドットファイルを作成しても正常動作する
- [ ] 両ペインが同じディレクトリを表示している場合に両方が更新される
- [ ] 親ディレクトリ(..)選択時にrキーが無視される
- [ ] 既存の機能に影響を与えない

## スコープ外

以下の機能は今回の実装範囲外とします:

- 複数ファイルの一括作成
- テンプレートからのファイル作成
- 移動を伴うリネーム (別ディレクトリへの移動)
- リネーム時の現在のファイル名の表示
- ファイル名の補完機能
- リネーム/作成のアンドゥ機能

## 技術的な考慮事項

### 既存コードとの統合

- `internal/ui/dialog.go`: 新しい `InputDialog` 型を追加
- `internal/ui/model.go`: `n`, `N`, `r` キーのハンドリングを追加
- `internal/ui/keys.go`: 新しいキー定数を追加
- `internal/fs/operations.go`: `CreateFile`, `CreateDirectory`, `Rename` 関数を追加

### 既存パターンの再利用

- ダイアログの表示・管理: 既存の `ConfirmDialog`, `ErrorDialog` のパターンを踏襲
- テキスト入力: 既存の `Minibuffer` のテキスト編集ロジックを参考にする
- エラー表示: ステータスバーへのメッセージ表示は既存の仕組みを利用

## 依存関係

- Go標準ライブラリ (`os`, `path/filepath`)
- Bubble Tea フレームワーク
- lipgloss (スタイリング)
- 既存の `internal/fs` パッケージ
- 既存の `internal/ui` パッケージ

## リスクと懸念事項

### リスク

1. **ファイル名のバリデーション**
   - 問題: OS/ファイルシステムごとに無効な文字が異なる
   - 対策: パス区切り文字のみをチェックし、その他はファイルシステムに任せる

2. **隠しファイルの扱い**
   - 問題: カーソル位置の制御が複雑
   - 対策: 仕様を明確化し、テストケースで網羅する

3. **両ペイン同一ディレクトリのケース**
   - 問題: 再読み込みタイミングの同期
   - 対策: 両ペイン再読み込みで確実に反映

### 懸念事項

- テキスト入力ダイアログの実装が初めてのため、既存のダイアログパターンとの整合性に注意が必要
- カーソル位置の追従ロジックが複雑になる可能性

## 今後の拡張可能性

- ファイル名の補完機能
- テンプレートからのファイル作成
- リネーム時に現在のファイル名を初期値として表示するオプション
- 一括リネーム機能
