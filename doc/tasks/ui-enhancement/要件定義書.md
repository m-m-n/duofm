# 機能要件定義書: UIブラッシュアップ

## 概要

duofmのユーザーインターフェースを強化し、Total Commanderのような実用的な画面設計を実現します。具体的には、ヘッダー情報の追加、ファイルリストの詳細表示、シンボリックリンク対応の改善を実装します。

## 目的

- ファイル操作に必要な情報（マーク数、容量、空き容量）を常時表示する
- ユーザーが必要に応じて表示情報の詳細度を切り替えられるようにする
- シンボリックリンクを適切に扱い、リンク先の情報を表示する
- Total Commanderのような実用的なファイルマネージャーUIを提供する

## 機能要件

### 1. ヘッダー情報の拡張

#### 1.1 現在の表示

```
/home/user/Documents
────────────────────
ファイルリスト...
```

#### 1.2 新しい表示（2行構成）

**通常時:**
```
/home/user/Documents
Marked 3/15 12.5 MiB    150 GiB Free
────────────────────
ファイルリスト...
```

**ローディング時:**
```
/home/user/Documents
Loading directory... (1234 files loaded)
────────────────────
（ローディング中）
```

**1行目**: ディレクトリパス（既存実装のまま）
- 現在のディレクトリの絶対パスを表示
- ホームディレクトリ配下の場合、ホームディレクトリ部分を`~`で省略表示（例: `/home/user/Documents` → `~/Documents`）

**2行目**: マーク情報と空き容量、またはローディング状態
- 通常時: `Marked X/N SIZE` + `SIZE Free`
- ローディング時: `Loading directory...` + 進捗情報（オプション）

#### 1.3 詳細仕様

**マーク情報:**
- `X`: マークされたファイル/ディレクトリの数
- `N`: 表示されているファイル/ディレクトリの総数（`..`を除く）
- `SIZE`: マークされたファイルの合計サイズ（1024進法、自動単位変換）
- マークが0個の場合: `Marked 0/N 0 B`

**空き容量:**
- パーティションの空き容量を表示
- 1024進法で単位自動変換（B, KiB, MiB, GiB, TiB）
- 5秒ごとにリフレッシュ（将来的には設定ファイルで`refresh_rate`として変更可能にする予定）

**レイアウト:**
- 左側: マーク情報
- 右側: 空き容量
- 中央: スペースで埋める

### 2. ファイルリストの詳細表示

#### 2.1 表示モードの種類

表示モードは**端末幅**と**ユーザーの選択**によって決定されます。

##### 2.1.1 端末幅が狭い場合（自動）

端末幅が十分でない場合、**自動的に**ファイル/ディレクトリ名のみを表示します。
この場合、`i`キーは**無効**（何も起こらない）になります。

**ミニマルモード（自動切り替え）:**
```
../
Projects/
README.md
notes.txt
config.conf -> /etc/app/config.conf
```

##### 2.1.2 端末幅が十分に広い場合（手動切り替え）

端末幅が十分に広い場合、`i`キーで**2つのモード**を切り替えます。

**モードA: 基本情報モード（デフォルト）**
```
../
Projects/         -        2024-12-10 09:00
README.md         1.2 KiB  2024-12-01 10:30
notes.txt         450 B    2024-11-28 15:45
config.conf -> /etc/app/config.conf  512 B  2024-12-01 10:30
```

表示カラム:
- ファイル名
- ファイルサイズ
- タイムスタンプ

**モードB: 詳細情報モード**
```
../
Projects/         rwxr-xr-x  user  staff
README.md         rw-r--r--  user  staff
notes.txt         rw-r--r--  user  staff
config.conf -> /etc/app/config.conf  rw-r--r--  user  staff
```

表示カラム:
- ファイル名
- パーミッション
- 所有者
- グループ

**切り替え動作:**
- `i`キー: モードA ⇔ モードB
- 端末幅が狭くなった場合: 自動的にミニマルモードに切り替わり、`i`キーが無効化される
- 端末幅が広くなった場合: 最後に選択していたモード（AまたはB）に戻り、`i`キーが有効化される

#### 2.2 カラム仕様

**ファイル名:**
- 左揃え
- ディレクトリには末尾に`/`を付与
- 親ディレクトリは`../`で表示
- シンボリックリンクは`name -> target`形式で表示
- 可変幅（端末幅に応じて調整）

**ファイルサイズ:**
- 右揃え
- 1024進法で自動単位変換（B, KiB, MiB, GiB, TiB）
- ディレクトリは`-`で表示
- 固定幅（自動決定）

**タイムスタンプ:**
- フォーマット: `2024-12-17 22:28`（ISO 8601準拠）
- Goの`time.Format("2006-01-02 15:04")`を使用
- 年-月-日 時:分の形式
- 24時間制
- 固定幅（16文字: `2024-12-17 22:28`）
- カスタマイズ不可（シンプルさを優先）

**パーミッション:**
- 固定幅（10文字: `rwxrwxrwx`形式）
- Unix形式のパーミッション表示

**所有者:**
- 左揃え
- ユーザー名を表示
- 固定幅（自動決定）

**グループ:**
- 左揃え
- グループ名を表示
- 固定幅（自動決定）

#### 2.3 端末幅の閾値

端末幅による表示モード切り替えの閾値:
- **ミニマルモード強制**: 端末幅 < 60カラム（目安、実装時に調整）
- **モードA/B切り替え可能**: 端末幅 >= 60カラム

この閾値は、カラム幅の合計を計算して動的に決定します。

#### 2.4 表示モードの管理

- 各ペインで独立して表示モードを切り替え可能（モードAとモードB）
- 端末幅が狭い場合は自動的にミニマルモードになり、`i`キーは無効
- アプリケーション再起動時には設定をリセット（永続化しない）
- ステータスバーには現在のモードを表示しない（実装後に不便なら別途追加検討）

### 3. シンボリックリンク対応の改善

#### 3.1 現在の問題点

- シンボリックリンク先がディレクトリでも先を辿れない
- リンク先の情報が表示されない
- リンク切れの判別ができない

#### 3.2 改善内容

**表示形式:**
```
config.conf -> /etc/app/config.conf    512 B    2024-12-01 10:30
logs -> /var/log/app/                    -      2024-12-10 09:00
broken -> /missing/file                  ?      2024-11-15 08:00
```

**リンク先表示:**
- フォーマット: `ファイル名 -> リンク先の絶対パス`
- リンク先のパスが長い場合は省略（末尾に`...`）

**リンク切れの視覚的表現:**
- 色を変更（例: 赤色、グレーアウトなど）
- サイズ欄に`?`を表示
- リンク切れマーク（色、アイコンなど）を追加

**Enterキー押下時の挙動:**
- リンク先が存在し、ディレクトリの場合 → リンク先ディレクトリに移動
- リンク先が存在し、ファイルの場合 → 何もしない（Phase 2でファイルオープン機能実装予定）
- リンク先が存在しない場合 → 何もしない（エラーダイアログも表示しない）

**シンボリックリンク情報の取得:**
- `os.Readlink()`でリンク先パスを取得
- `os.Stat()`でリンク先の存在確認
- リンク先がディレクトリかファイルかを判定

### 4. ローディング表示

#### 4.1 目的

大量のファイル（数千〜数万）があるディレクトリを開く際、ユーザーにフィードバックを提供する。

#### 4.2 表示タイミング

- ディレクトリの読み込みに時間がかかる場合（目安: 0.5秒以上）
- ディレクトリ移動時、リフレッシュ時

#### 4.3 表示位置と内容

**ヘッダーの2行目に表示:**
```
/home/user/large-directory
Loading directory... (1234 files loaded)
────────────────────
（まだ読み込み中）
```

または、パーセンテージ表示:
```
/home/user/large-directory
Loading... 45%
────────────────────
（まだ読み込み中）
```

**表示内容:**
- `Loading directory...` - 基本のローディングメッセージ
- `(N files loaded)` - 現在までに読み込んだファイル数（オプション）
- `N%` - 進捗率（計算可能な場合のみ）

**通常のヘッダー2行目（マーク情報と空き容量）は、ローディング中は表示されません。**

#### 4.4 実装方針

- Bubble Teaの非同期メッセージングを活用
- ディレクトリ読み込みをgoroutineで実行
- 読み込み中はヘッダー2行目にローディング状態を表示
- 読み込み完了後、ヘッダー2行目を通常表示（マーク情報と空き容量）に切り替え

## 技術要件

### データ構造の拡張

**FileEntry構造体（既存）:**
```go
type FileEntry struct {
    Name        string
    IsDir       bool
    Size        int64
    ModTime     time.Time
    Permissions fs.FileMode
}
```

**拡張が必要な情報:**
```go
type FileEntry struct {
    Name        string
    IsDir       bool
    Size        int64
    ModTime     time.Time
    Permissions fs.FileMode
    Owner       string      // 所有者名（新規追加）
    Group       string      // グループ名（新規追加）
    IsSymlink   bool        // シンボリックリンクか（新規追加）
    LinkTarget  string      // リンク先パス（新規追加）
    LinkBroken  bool        // リンク切れか（新規追加）
}
```

### Pane構造体の拡張

```go
type Pane struct {
    path         string
    entries      []fs.FileEntry
    cursor       int
    scrollOffset int
    width        int
    height       int
    isActive     bool
    displayMode  DisplayMode  // 表示モード（新規追加）
    markedFiles  map[int]bool // マークされたファイルのインデックス（将来実装）
    loading      bool         // ローディング中か（新規追加）
}

type DisplayMode int
const (
    DisplayMinimal DisplayMode = iota  // 名前のみ（端末幅が狭い場合に自動）
    DisplayBasic                        // 名前 + サイズ + タイムスタンプ（モードA、デフォルト）
    DisplayDetail                       // 名前 + パーミッション + 所有者 + グループ（モードB）
)
```

### Model構造体の拡張

```go
type Model struct {
    leftPane          *Pane
    rightPane         *Pane
    leftPath          string
    rightPath         string
    activePane        PanePosition
    dialog            Dialog
    width             int
    height            int
    ready             bool
    lastDiskSpaceCheck time.Time      // 最後の空き容量チェック時刻（新規追加）
    leftDiskSpace     uint64          // 左ペインの空き容量（新規追加）
    rightDiskSpace    uint64          // 右ペインの空き容量（新規追加）
}
```

## 実装フェーズ

### Phase 1: 基本機能（本要件の範囲）

1. ヘッダー情報の2行表示
2. 空き容量の取得と表示（5秒ごとのリフレッシュ）
3. 表示モードの切り替え（`i`キー）
4. ファイルサイズとタイムスタンプの表示
5. パーミッション、所有者、グループの表示
6. シンボリックリンクの表示とリンク先への移動
7. ローディング表示

### Phase 2: マーク機能（将来実装）

1. ファイルのマーク/アンマーク（`Space`キー）
2. マークされたファイル数と合計サイズの計算
3. マークされたファイルの一括操作

### Phase 3: 設定ファイル対応（将来実装）

1. 空き容量リフレッシュレートの設定
2. デフォルト表示モードの設定
3. カラーテーマの設定

## UI/UXの考慮事項

### ユーザビリティ

- 表示モードの切り替えは即座に反映される
- 端末幅が狭い場合でも最低限の操作性を確保
- ローディング中もアプリケーションは応答性を維持

### アクセシビリティ

- 色だけでなくテキストでも情報を伝える（リンク切れの`?`マークなど）
- 十分なコントラストを確保

### パフォーマンス

- 空き容量は5秒間キャッシュ（頻繁なディスクアクセスを避ける）
- ファイル情報の取得は一度だけ（表示モード切り替え時に再取得しない）
- 大量ファイル時もUIが固まらない（非同期読み込み）

## テストシナリオ

### 1. ヘッダー情報の表示

- [ ] ディレクトリパスが正しく表示される
- [ ] ホームディレクトリが`~`で表示される
- [ ] ファイル数が正しくカウントされる（`..`を除く）
- [ ] 空き容量が適切な単位で表示される
- [ ] 空き容量が5秒ごとに更新される

### 2. 表示モードの切り替え

- [ ] 端末幅が狭い場合、自動的にミニマルモード（名前のみ）になる
- [ ] 端末幅が狭い場合、`i`キーが無効化される（何も起こらない）
- [ ] 端末幅が広い場合、`i`キーでモードA（基本情報）⇔モードB（詳細情報）を切り替えられる
- [ ] 左右のペインで独立して表示モードを切り替えられる
- [ ] モードAでファイル名、サイズ、タイムスタンプが表示される
- [ ] モードBでファイル名、パーミッション、所有者、グループが表示される
- [ ] 端末幅が広くなった場合、最後に選択していたモードに戻る

### 3. ファイル情報の表示

- [ ] ファイルサイズが適切な単位（B, KiB, MiB, GiB, TiB）で表示される
- [ ] ディレクトリのサイズが`-`で表示される
- [ ] タイムスタンプが適切なフォーマットで表示される
- [ ] パーミッションがUnix形式（rwxrwxrwx）で表示される
- [ ] 所有者とグループが表示される

### 4. シンボリックリンクの挙動

- [ ] シンボリックリンクが`name -> target`形式で表示される
- [ ] リンク先がディレクトリの場合、Enterでディレクトリに移動できる
- [ ] リンク先がファイルの場合、Enterで何も起こらない
- [ ] リンク切れの場合、視覚的に区別される
- [ ] リンク切れの場合、サイズ欄に`?`が表示される
- [ ] リンク切れの場合、Enterで何も起こらない

### 5. ローディング表示

- [ ] 大量のファイルがあるディレクトリを開く際、ヘッダー2行目にローディング表示が出る
- [ ] ローディング中、マーク情報と空き容量の表示が一時的に隠れる
- [ ] ローディング中もアプリケーションが応答する
- [ ] ディレクトリ読み込み完了後、ヘッダー2行目が通常表示（マーク情報と空き容量）に戻る
- [ ] 読み込んだファイル数が表示される（オプション）

### 6. レイアウトとレスポンシブ

- [ ] カラム幅が自動的に調整される
- [ ] 端末のリサイズに対応する
- [ ] 長いファイル名が適切に省略される
- [ ] 長いリンク先パスが適切に省略される

## 成功基準

- [ ] ヘッダーにマーク情報と空き容量が表示される
- [ ] 端末幅が広い場合、`i`キーでモードA⇔モードBを切り替えられる
- [ ] 端末幅が狭い場合、自動的にミニマルモードになり`i`キーが無効化される
- [ ] 各ペインで独立して表示モードを切り替えられる
- [ ] モードAでファイルサイズ、タイムスタンプが適切に表示される
- [ ] モードBでパーミッション、所有者、グループが表示される
- [ ] シンボリックリンク先に移動できる
- [ ] リンク切れが視覚的に判別できる
- [ ] 大量ファイル時にヘッダー2行目にローディング表示が出る
- [ ] 端末幅が狭い場合でも操作可能（ミニマルモード）

## 備考

### 将来的な拡張

- ファイルマーク機能の実装（Phase 2）
- マークされたファイルの合計サイズ表示
- 設定ファイルでのカスタマイズ（リフレッシュレートなど）
- ステータスバーへの表示モード表示（必要に応じて）

### 参考

- Total Commander: https://www.ghisler.com/
- 既存の実装: `doc/tasks/ui-design/SPEC.md`
