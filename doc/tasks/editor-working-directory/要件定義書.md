# 要件定義書: エディタ/ビューア作業ディレクトリ修正

## 概要

duofmでファイルをview（表示）やedit（編集）する際に、外部アプリケーション（エディタ/ビューア）の作業ディレクトリを現在のペインのディレクトリに設定する。これにより、エディタやビューア内での相対パス操作が直感的に行えるようになる。

## 背景と問題点

### 現状の問題
1. `v`（view）や`e`（edit）キーで外部アプリケーションを起動する際、作業ディレクトリが設定されていない
2. エディタ（vim等）内で`:!ls`などのシェルコマンドを実行すると、duofmの起動ディレクトリで実行されてしまう
3. vimでの`:e .`や`:Ex`で表示されるディレクトリが編集対象ファイルのディレクトリではない
4. `!`キーによるシェルコマンド実行では正しく作業ディレクトリが設定されているため、動作に一貫性がない

### 期待される動作
- エディタやビューアが起動する際、作業ディレクトリは現在アクティブなペインのディレクトリであるべき
- エディタ内でのシェルコマンドやファイル操作が、そのディレクトリを基準に行われる

## 目的

- ファイル編集/表示時の作業ディレクトリを現在のペインのディレクトリに設定する
- `!`キーによるシェルコマンド実行と同様の動作にする
- 環境変数（$EDITOR、$PAGER）を優先して使用する

## ユーザーストーリー

1. **エディタでの作業ディレクトリ**
   - ユーザーとして、`e`キーでファイルを編集する際に、エディタ内で`:!ls`を実行すると、編集対象ファイルと同じディレクトリの一覧が表示されてほしい
   - ユーザーとして、vimで`:e .`を実行すると、編集対象ファイルと同じディレクトリが表示されてほしい

2. **ビューアでの作業ディレクトリ**
   - ユーザーとして、`v`キーでファイルを表示する際に、ビューア内でシェル連携機能を使用すると、表示対象ファイルと同じディレクトリで実行されてほしい

3. **環境変数の尊重**
   - ユーザーとして、$EDITOR環境変数にnanoを設定していれば、`e`キーでnanoが起動してほしい
   - ユーザーとして、$PAGER環境変数にmoarを設定していれば、`v`キーでmoarが起動してほしい

## 機能要件

### FR1: 作業ディレクトリの設定

| ID | 要件 |
|----|------|
| FR1.1 | `e`キーでファイルを編集する際、外部アプリケーションの作業ディレクトリをアクティブペインのディレクトリに設定する |
| FR1.2 | `v`キーでファイルを表示する際、外部アプリケーションの作業ディレクトリをアクティブペインのディレクトリに設定する |
| FR1.3 | `Enter`キーでファイルを開く際、外部アプリケーションの作業ディレクトリをアクティブペインのディレクトリに設定する |

### FR2: 環境変数の優先使用

| ID | 要件 |
|----|------|
| FR2.1 | `e`キーでファイルを編集する際、$EDITORが設定されていればそのコマンドを使用する。未設定の場合はvimを使用する |
| FR2.2 | `v`キーでファイルを表示する際、$PAGERが設定されていればそのコマンドを使用する。未設定の場合はlessを使用する |
| FR2.3 | `Enter`キーでファイルを開く際、$PAGERが設定されていればそのコマンドを使用する。未設定の場合はlessを使用する |

## 非機能要件

| ID | 要件 |
|----|------|
| NFR1.1 | 既存の動作（ファイルパスの受け渡し、エラーハンドリング）に影響を与えない |
| NFR1.2 | $EDITOR/$PAGERが未設定の場合のフォールバック動作は現状と同じ（vim/less） |

## 入力/出力仕様

### 入力

| キー | 対象 | 動作 |
|-----|------|------|
| `v` | ファイル | $PAGER（未設定時less）で表示 |
| `e` | ファイル | $EDITOR（未設定時vim）で編集 |
| `Enter` | ファイル | $PAGER（未設定時less）で表示 |

### 外部アプリケーションへの引き渡し

| 項目 | 値 |
|------|-----|
| ファイルパス | ファイルの絶対パス（現状通り） |
| 作業ディレクトリ | アクティブペインのディレクトリパス |
| コマンド | 環境変数または固定値 |

## テストシナリオ

### 作業ディレクトリ

- [ ] `v`キーでファイルを開き、lessで`!pwd`を実行すると、ファイルのあるディレクトリが表示される
- [ ] `e`キーでファイルを開き、vimで`:!pwd`を実行すると、ファイルのあるディレクトリが表示される
- [ ] `e`キーでファイルを開き、vimで`:e .`を実行すると、ファイルのあるディレクトリのファイル一覧が表示される

### 環境変数

- [ ] $EDITORにnanoを設定して`e`キーを押すと、nanoが起動する
- [ ] $PAGERにmoarを設定して`v`キーを押すと、moarが起動する
- [ ] $EDITORが未設定の場合、vimが起動する
- [ ] $PAGERが未設定の場合、lessが起動する

### 既存動作の維持

- [ ] ディレクトリに対する`v`/`e`キーは何も起こらない（現状通り）
- [ ] `..`に対する`v`/`e`キーは何も起こらない（現状通り）
- [ ] 読み取り権限のないファイルに対してはエラーメッセージが表示される（現状通り）

## 成功基準

- [ ] 外部アプリケーション内で作業ディレクトリがアクティブペインのディレクトリになっている
- [ ] 環境変数$EDITOR/$PAGERが優先される
- [ ] 環境変数未設定時はvim/lessがフォールバックとして使用される
- [ ] 既存のテストがすべてパスする
- [ ] 新規テストがすべてパスする

## 制約事項

- 現在の`!`キーによるシェルコマンド実行の動作と一貫性を保つ
- 外部アプリケーションの起動方式（`tea.ExecProcess`）は変更しない

## 未解決事項

なし
